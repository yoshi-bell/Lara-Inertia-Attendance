# Lara-Inertia-Attendance 開発ログ (Development Log)

## 概要

このドキュメントは、旧勤怠アプリ（Laravel 8 / Blade）を、最新の技術スタック（Laravel 12 / Inertia / React / TypeScript）へリファクタリングするプロセス、技術的決定事項、および学習の軌跡を記録するものです。

---

## 2026-02-06: プロジェクト始動とドキュメント基盤の確立

### 1. プロジェクトの目的と方針

- **目的:** 既存の勤怠アプリを現代的なアーキテクチャで再構築し、保守性とユーザー体験を向上させる。
- **基本方針:**
    - **Inertia.js によるモダンモノリス:** API分離の手間を省きつつ、SPAのような高速な操作感を実現。
    - **TypeScript の徹底:** フロントエンド・バックエンド共に型安全性を追求。
    - **ドキュメント駆動開発:** `lara-next-reserve` で確立した「憲法・法律・マニュアル」の仕組みを継承し、AIとの高度な協働を維持する。

### 2. 環境構築とドキュメント整備

- **Laravel 12 初期化:** `curl` コマンドを使用して最新の Laravel Sail 環境を構築。
- **ドキュメント移植と最適化:**
    - `02_RULES_AND_ARCHITECTURE.md` (憲法): Inertia モノリス構成に合わせて刷新。
    - `99_OLD_IMPLEMENTATION_STANDARDS.md` (実装標準): 旧コーディング規約をリネーム。型自動生成や Hybrid バリデーションの方針を明文化。論理式の括弧使用ルールを追加。
    - `03_WORKFLOW.md` (ロードマップ): リファクタリング用の 5 Phase ロードマップを策定。
    - `01_AGENT_RECOVERY_MANUAL.md` (復旧手順): 新環境の検証項目へ更新。
- **Laravel Breeze (Inertia/React) の導入:**
    - `breeze:install react --typescript` を実行し、認証基盤と React 環境を構築。
    - **技術的課題と解決:** `npm install` 時に Vite 7 と `@types/node` のバージョン不整合による `ERESOLVE` エラーに遭遇。`@types/node@latest` の明示的インストールと `--legacy-peer-deps` フラグの使用により、依存関係を正常に解消。
    - **動作確認:** ユーザー登録からダッシュボード表示までの一連の SPA 動作を確認。
- **品質管理ツール (Lint/Format) の設定:**
    - **PHP:** Laravel Pint を導入し、Laravel 標準スタイルでの自動整形を確認。
    - **React/TypeScript:** Prettier (Tailwindプラグイン付) と ESLint (Flat Config) を導入。
    - **プロジェクト憲法の反映:** ESLint において `any` 型の使用を禁止し、Prettier でクラス名の自動並び替えを強制。

### 3. データとモデルの移行 (Phase 2)

- **マイグレーションの移植:**
    - 旧プロジェクトから `attendances`, `rests`, `attendance_corrections`, `rest_corrections` のテーブル定義を移植。
    - 最新の無名クラスマイグレーション形式へリファクタリングして適用。
- **`users` テーブルの拡張:** 管理者機能を見据え、`is_admin` カラムを初期マイグレーションに追加。
- **データベース構築:** `migrate:fresh` により、全7テーブル（認証系含む）の構築が正常に完了したことを確認。
- **Eloquent モデルの移植:**
    - `Attendance`, `Rest`, `AttendanceCorrection`, `RestCorrection` の各モデルを新規作成。
    - 旧プロジェクトからリレーションおよびビジネスロジック（計算アクセサ）を忠実に移植。
- **シーディング基盤の構築:**
    - 旧プロジェクトの `UserSeeder`, `AttendancesTableSeeder`, `AttendanceCorrectionSeeder` を移植。
    - **安定性の確保:** 工夫によるデグレードを避けるため、旧プロジェクトのランダムデータ生成ロジック（昨日を起点に過去60日分）をそのまま再現。
    - **データ投入成功:** 約1300件の勤怠・休憩データ、および約80件の修正申請データを生成し、開発環境を整えた。

### 4. 一般ユーザー機能の実装 (Phase 3)

- **フロントエンド基盤の強化 (Shadcn/ui):**
    - Shadcn/ui を導入し、モダンな UI コンポーネント（Button, Input, Card 等）を利用可能にした。
    - **設計判断:** ディレクトリ構造を整理。React コンポーネントは大文字開始（`Components`, `Pages`）、ロジック・ユーティリティは小文字開始（`lib`, `types`）という慣習を確立し、`99_OLD_IMPLEMENTATION_STANDARDS.md` を更新。
- **認証画面のリファクタリング:**
    - `Login.tsx`, `Register.tsx` を Shadcn/ui を使用して再構築。
    - 旧プロジェクトのデザイン（タイトル、ラベル、リンク構成）を忠実に再現しつつ、UI 品質を向上させた。
- **打刻機能（Attendance/Index）の実装:**
    - **フロントエンド:** React の `useEffect` を用いたリアルタイムクロックを実装。Shadcn/ui の `Card` や `Button` を活用し、旧プロジェクトのデザインをモダンに再現。
    - **バックエンド:** `AttendanceService` を新設し、打刻ロジック（二重出勤防止、休憩中退勤不可など）を集約。コントローラーの肥大化を防ぎつつ、旧プロジェクトの仕様を完全移植。
    - **Inertia 連携:** `router.post` を活用し、SPA 特有の高速な状態遷移（打刻後のボタン切り替わり）を実現。

### 2026-02-06 (続き): 勤怠一覧機能の構築とレイアウトの刷新

#### 1. デザイン再現のためのレイアウト刷新

- **設計判断:** Laravel Breeze 標準の `AuthenticatedLayout` は白系統のデザインであり、旧プロジェクトの「黒ヘッダー」「背景色 #F0EFF2」を再現するには構造的な乖離が大きかったため、学習も兼ねて `AttendanceLayout.tsx` を新規作成。
- **実装内容:**
    - 旧プロジェクトの `common.css` および `app.blade.php` の構造を React (Tailwind CSS) で忠実に再現。
    - 黒いヘッダー、ロゴ画像、シンプルなテキストリンクによるナビゲーションを実装。
    - `title` と `headerContent` を Props として受け取る設計にすることで、各ページ固有のヘッダー要素（月次ナビゲーションなど）を柔軟に差し込めるようにした。
- **ロゴの移植:** 旧プロジェクトから `logo.svg` を `public/images/` に移植。

#### 2. 勤怠一覧ページ（Attendance/List）の実装

- **Shadcn/ui の活用:** `Table` コンポーネント群を使用し、アクセシビリティと保守性を確保。
- **デザインの再現:** 旧プロジェクトの `attendance-list.css` のトンマナを Tailwind クラスで再現。
    - `tracking-[3px]` による文字間隔の調整。
    - `border-b-[3px]` や `#E1E1E1` を用いたボーダーの再現。
    - `rounded-[10px]` による角丸の適用。
- **月次ナビゲーション:** `AttendanceLayout` の `headerContent` を利用し、前月・翌月への切り替えリンクを実装. `router.get` による月指定の遷移を実現。

#### 3. ルーティングとコントローラーの拡張

- **詳細画面の準備:** `routes/web.php` に詳細表示用ルートを追加。
- **コントローラー:** `AttendanceController` に `show` メソッドを追加し、詳細ページ（`Attendance/Detail`）へのレンダリングを定義。

### 2026-02-09: TypeScript 型定義ポリシーの厳格化と勤怠詳細ページの実装

#### 1. TypeScript 偏差値向上を目指した「最強の法律」の策定

- **背景:** スコアの向上とプロジェクトの堅牢性確保のため、型定義ポリシーを大幅に強化。
- **実装内容:**
    - `99_OLD_IMPLEMENTATION_STANDARDS.md` を更新し、`any` 禁止、`unknown` + 型ガードの義務化、`as const` による定数一元管理、Zod との統合、命名規則 (`[Component]Props`) を明文化。
    - `resources/js/types/models.d.ts` を新設し、SSOT (Single Source of Truth) の原則に基づく中央集権的な型管理を開始。
- **効果:** AI エージェントへの指示が「型システム」レベルで厳格化され、開発品質の底上げを実現。

#### 2. 勤怠詳細ページ（Attendance/Detail）のモダンリファクタリング

- **型設計:** 新ポリシーに基づき、`useForm<CorrectionForm>` のジェネリクス明示や、モデル型の継承・交差型を駆使した厳密な Props 定義を実施。
- **レイアウト課題と解決:**
    - Shadcn UI のデフォルトスタイル（`w-full`, `display: flex`）が旧デザインの再現（固定幅ラベル等）と衝突する問題に直面。
    - **技術的判断:** フレームワークの干渉を排除するため、標準の `input`, `textarea` タグへ原点回帰。
    - **決定打:** Tailwind の JIT ビルドや Flexbox の自動計算に依存せず、`style` 属性（インラインスタイル）でピクセル単位の幅 (`256px`) を強制適用。これにより、最も堅牢な方法でレイアウトを固定。
- **機能実装:**
    - 既存の休憩データから動的にフォーム値を生成するロジックを実装。
    - 「承認待ち申請」の有無による動的な UI 切り替え（編集不可状態の視覚的表現）を実現。

### 2026-02-09 (続き): 修正申請機能のバックエンド実装

#### 1. FormRequest の移植と強化
- `AttendanceCorrectionRequest` を作成。
- 旧プロジェクトのバリデーションロジック（出退勤の順序チェック、休憩時間の重複チェック）を完全移植。
- PHP 8.4 の型定義と Route Model Binding を活用して記述を最適化。

#### 2. Service層の実装とトラブルシューティング
- `CorrectionService` を実装し、トランザクションを用いた安全なデータ保存（申請本体 + 休憩修正）を実現。
- **エラー解決:** `Field 'requester_id' doesn't have a default value` エラーが発生。
    - **原因:** 新プロジェクト作成時にカラム名を `user_id` に変更しようとしたが、DBスキーマは旧プロジェクトの `requester_id` のままであったため不整合が発生。
    - **対処:** 旧プロジェクトの仕様を「正」とし、サービス側の記述を `requester_id` に修正して解決。

#### 3. コントローラーとルーティング
- `AttendanceController@storeCorrection` を実装し、申請完了後のリダイレクトとフラッシュメッセージを設定。
- `POST /attendance/{attendance}/correction` ルートを開通。

#### 4. フロントエンドの UX 改善とバリデーション強化
- **エラー表示の網羅:** `Detail.tsx` において、出退勤および休憩時間の各入力項目に対してバリデーションエラーメッセージの表示処理を追加。動的なキー名 (`rests.1.start_time` 等) に対応。
- **入力制限の厳格化:** `input[type="time"]` へのキーボード入力を無効化 (`onKeyDown`) し、クリック時に標準ピッカーを強制起動 (`showPicker`) させることで、誤入力を防ぎ UX を向上させた。
- **ブラウザバリデーションの無効化:** `noValidate` を追加し、サーバーサイドのバリデーション結果を確実に表示するように調整。

### 2026-02-10: 申請一覧ページの実装と基本設計書への完全準拠

#### 1. 申請一覧ページ (US009) の構築
- **共通コンポーネント化:** 管理者機能での再利用を見据え、`CorrectionList.tsx` を共通コンポーネントとして実装。承認待ち/承認済みのタブ切り替え機能を統合。
- **Inertia 連携:** クエリパラメータ (`status`) による表示データの動的なフィルタリングを実現。
- **UI 再現:** 旧プロジェクトのテーブル構造とタブデザインを Shadcn UI Table と Tailwind で再現。

#### 2. 基本設計書に基づくルーティングの精査・修正
- **パスの完全一致:** `web.php` を基本設計書 (CSV) および旧プロジェクトの定義と突き合わせ、詳細画面 (`/attendance/detail/{id}`) や申請一覧 (`/stamp_correction_request/list`)、送信パス (`/attendances/correction/{id}`) を正確に反映。
- **整合性の確保:** ナビゲーションリンクおよび `Detail.tsx` 内の `route()` 名を一斉に修正し、設計書通りの URL 体系を確立。

#### 3. セキュリティとプライバシーの配慮
- `docs-private/project-detail` フォルダを Git 管理から除外し、リモートリポジトリから削除することで機密情報を保護。

### 2026-02-10 (続き): 管理者認証の構築とレイアウトのコンポーネント化

#### 1. 管理者認証基盤 (US004, US005) の実装
- **Admin\LoginController:** 管理者専用のログイン・ログアウトロジックを実装。`is_admin` フラグによる厳格な認可チェック（ログイン試行後の事後検証）を統合。
- **AdminMiddleware:** 管理者専用ルートを保護する `is_admin` ミドルウェアを新設し、シングルガード下でのアクセス制御を実現。
- **専用 LoginRequest:** 管理者ログインに特化したバリデーションルールを分割作成し、保守性を向上。

#### 4. 認証・認可のセキュリティ強化（多層防御）
- **GeneralUserMiddleware:** 一般ユーザー専用ページへの管理者アクセスを遮断するミドルウェアを導入。
- **RoleRedirectMiddleware:** ログイン済みユーザーがログイン画面にアクセスした際、役割に応じて適切なホーム画面へ誘導するロジックを実装。
- **ログイン処理の厳格化:** `AuthenticatedSessionController` (一般用) においても `is_admin` チェックを追加し、管理者が一般フォームからログインすることを防止。

#### 5. ルーティングの最適化と基本設計書への準拠
- **web.php のリファクタリング:** 
    - 管理者用コントローラーに `as` エイリアス（`AdminLoginController`, `AdminAttendanceController`）を適用し、名前の衝突を回避しつつ可読性を向上。
    - `middleware('guest')` のグループ化により、冗長な記述を排除。
    - ログイン済みユーザーの入り口（`/`）を役割に応じて動的に振り分けるロジックへ変更。
- **クリーンコードの徹底:** 未使用の `use Inertia\Inertia;` を削除し、コードの純粋性を確保。

#### 2. React の長所を活かしたコンポーネント化
- **設計思想の転換:** 旧プロジェクトの `@extends` 構造を、React の「コンポーネント指向」へ昇華。
- **Header & Navigation コンポーネント:** 
    - ログイン状態や `is_admin` フラグを Props で受け取り、動的に表示内容を切り替える疎結合な設計を採用。
    - ログイン画面 (`Admin/Login.tsx`) でも `Header` 部品を直接利用することで、コードの重複を排除しつつデザインの一貫性を確保。
- **AttendanceLayout:** ヘッダーロジックを排除し、純粋な「ページ枠組み（背景・最大幅）」の定義に特化。

#### 3. セキュリティを重視したページ構成のリファクタリング
- **ページファイルの分離:** 管理者用と一般ユーザー用の詳細ページを `Pages/Admin/Attendance/Detail.tsx` と `Pages/Attendance/Detail.tsx` に完全に分離。認可の境界を明確化。
- **UI共通パーツの抽出:** `CorrectionForm.tsx` を新設し、入力フォームの UI を共通化。DRY 原則を維持しつつ、各ページで異なる送信ロジック（POST/PUT）をカプセル化した。

#### 4. 管理者用日次勤怠一覧 (US010) の実装
- **Admin/Attendance/Index:** 全ユーザーの日次データを表示。名前カラムの追加と日付ナビゲーションを実装。
- **UX 工夫:** 標準の `input type="date"` を透明化してアイコンに重ねることで、直感的な日付選択を実現。

#### 5. SPA 特有の課題解決と UX の昇華
- **ステート不整合の解決:** 更新後に休憩データが表示されない問題を、`useEffect` によるステート同期（`reset()`）で解決。
- **モダンな更新挙動:** `back()` リダイレクトと `preserveScroll` を組み合わせ、ページ遷移なしの非同期更新を実現。
- **共有 Props の拡張:** `HandleInertiaRequests.php` を修正し、セッション（フラッシュメッセージ）を Inertia 全体で共有。
- **UIによる通知設計:** 一般ユーザー側では、あえてフラッシュメッセージを表示せず「ボタンから警告テキストへのUI切り替わり」のみで完了を伝える、ノイズの少ないUXを採用。

#### 6. カスタムフックによるロジックの共通化
- **useCorrectionForm.ts:** 一般ユーザー用と管理者用の詳細ページで重複していた「フォーム初期化」「データ同期」「送信処理」のロジックをカスタムフックに集約。
- **設計的メリット:** ページコンポーネントを純粋な UI 構成のみにスリム化。isAdmin フラグによる送信メソッド（POST/PUT）の自動切り替えを実装し、保守性と拡張性を大幅に向上させた。

#### 7. 管理者用修正申請承認フロー (US014, US015) の実装

- **Admin/CorrectionRequest/Index:** 全ユーザーの申請一覧を構築。共通コンポーネント `CorrectionList` を再利用し、一般・管理者間での DRY 原則を達成。

- **Admin/CorrectionRequest/Approve.tsx:** 

    - **セマンティックな命名:** 画面の意図を明確にするため、旧プロジェクトに準拠した `Approve.tsx` を採用。

    - **承認ロジック:** 申請内容の最終確認と、`CorrectionService` を通じた勤怠データの反映フローを完遂。

- **環境トラブルシューティング:** Vite/Tailwind の JIT ビルドが新しいディレクトリ追加を検知しない問題に対し、開発サーバーの再起動による解決プロセスを確認。



#### 8. 型定義の厳格化と一本化 (TypeScript 偏差値向上)
- **SSOTの徹底:** `RestCorrection` 等の重複定義を排除し、`models.d.ts` に集約。プロパティ不足による実行時エラーを未然に防ぐ構造を確立。
- **Inertia v2 型不整合の解決:** エクスポートされていない `UseFormSetData` に頼らず、`setData` のシグネチャを直接定義。`any` を完全に排除しつつ、柔軟なフォーム操作を可能にした。
- **型合成の活用:** 交差型 (`&`) や `Partial` を駆使し、リレーションを含む複雑な Props を正確に型付け。

#### 9. 修正申請詳細（Approve）のリファクタリング
- **Propsのオプショナル化:** `CorrectionForm.tsx` のフォーム用 Props を任意に設定し、閲覧専用モードを統合。
- **Approve.tsx のスリム化:** 不要な `useForm` ステートを排除し、コードの責務を明確化。

#### 10. 重大なバグの発見と分析 (次回の最優先事項)
- **タイムゾーン不整合:** 18時の打刻が一覧で9時になる等、UTC/JST の時差（9時間）が発生。サーバー・DB設定の見直しが必要。
- **時間計算ロジックの不備:** 休憩時間が「-1:-52」等のマイナス値になる、合計時間が一律「0:00」になる等の異常を確認。`Attendance` モデルのアクセサ（Carbon計算）の修正が必要。

- 重大なバグ（タイムゾーン・時間計算）の緊急修正。
- スタッフ管理 (US012, US013) の実装。
- 月次ナビゲーションにおける「月選択（カレンダー）」機能の強化。

---

## 2026-02-11 (続き): スタッフ管理機能の実装とコンポーネントの再利用化

### 1. スタッフ管理のバックエンド実装 (US012, US013, FN045)
- **Admin/StaffController の新設:** 
    - スタッフ一覧取得 (`index`)、個別月次勤怠取得 (`showAttendance`)、CSV出力 (`exportCsv`) を実装。
    - 既存の `CalendarService` をインジェクションし、一般ユーザー用一覧とロジックを完全共有（DRY原則）。
- **CSV出力の実装:** 
    - 旧プロジェクトの仕様を継承し、`stream_filter_prepend` を用いた Shift-JIS (CP932) 変換を実装。Excelでの文字化けを防止。

### 2. フロントエンドの再利用性向上 (React モダンリファクタリング)
- **AttendanceTable の共通化:** 
    - `Pages/Attendance/List.tsx` からテーブル部分を `Components/AttendanceTable.tsx` として抽出。
    - 遷移先ルート名を Props で切り替える設計により、一般・管理者の両画面での完全再利用を達成。
- **デザインの精密な再現:**
    - 旧プロジェクトの CSS 数値（1列目のパディング 96px、タイトルサイズ 30px 等）を Tailwind CSS の任意値指定で忠実に再現。
    - CSV出力ボタンの形状（184x50px）やホバー時の色変化（#6c757d）も再現。

### 3. ナビゲーションの整備
- `Components/Navigation.tsx` を更新し、管理者のヘッダーに「スタッフ一覧」への導線を追加。
- ページ間遷移の整合性を確保。

### 4. コンポーネントの再利用化（リファクタリング完遂）
- **MonthNavigation の抽出:**
    - 月次ナビゲーション（前月・現在月・翌月）を `Components/MonthNavigation.tsx` として共通化。
    - 一般・管理者の両画面での DRY 原則を達成。
- **TypeScript 型定義の厳格化:**
    - `models.d.ts` で `User` 型を再エクスポートするように修正し、SSOT 型管理の不備を解消。
    - ESLint の `any` 禁止ルールを徹底し、`MonthNavigation` の Props 型定義を型安全に修正。
- **セマンティックな命名へのリファクタリング（旧プロジェクト同期）:**
    - ページファイル名を `Index.tsx`, `Detail.tsx` といった汎用名から、旧プロジェクトの Blade ファイル名（`List.tsx`, `AttendanceList.tsx` 等）に完全に同期。
    - React コンポーネントの関数名もファイル名に合わせて変更し、React Developer Tools 上での識別性とセマンティックな意味合いを強化。
    - コントローラーの `Inertia::render` パスを一斉更新。

---

## 2026-02-11: 緊急バグ修正（タイムゾーン・時間計算ロジック）の完遂

### 1. タイムゾーン不整合の解消
- **現象:** `config/app.php` が `UTC` 設定だったため、打刻時刻が日本時間（JST）から9時間遅れて記録されていた。
- **修正:** `config/app.php` の `timezone` を `Asia/Tokyo`、`locale` を `ja` に変更。
- **効果:** `now()` による打刻が正しい日本時間で行われるようになり、運用上の混乱を解消。

### 2. 時間計算ロジックのリファクタリングと Carbon 3系対応
- **技術的課題:** Carbon 3系において `diffInSeconds` のデフォルト挙動が「絶対値」から「符号付き相対値」に変更されており、順序によってマイナス値が算出されていた。
- **修正内容:** 
    - `Attendance` モデルのアクセサを Laravel 12 推奨の `Attribute` クラスを用いた形式にリファクタリング。
    - `toTimeString()` を介して時刻文字列から再パースすることで、DB保存時の日付依存を排除。
    - `diffInSeconds` の引数順序を `start -> end` に統一し、確実に正の秒数を得るよう修正。

### 3. 深夜勤務（日跨ぎ）対応の実装
- **設計判断:** 「23:00 〜 翌01:00」のような勤務において、単純な時刻比較では「22時間勤務」と誤認されるエッジケースに対応。
- **実装内容:** `end < start` の場合に `addDay()` を実行し、終了時刻を翌日として扱う補正ロジックを出退勤および休憩計算の両方に導入。
- **検証:** Tinker による検証で、日跨ぎ勤務・休憩が秒単位まで正確に計算されることを確認。

### 4. 学習の成果
- **ライブラリのメジャーアップデートに伴う破壊的変更（Carbon 2→3）への対応経験。**
- **時刻計算における日付の扱いと境界条件（深夜跨ぎ）に対する防御的プログラミングの定着。**
- **Laravel 12 (PHP 8.4) における最新のモデルアクセサ実装パターンの習得。**

---

## 2026-02-12: メール認証機能の実装と設計の最適化（一元管理の導入）

### 1. メール認証機能の有効化 (FN011, FN012)
- **Backend:** `User` モデルに `MustVerifyEmail` を実装し、Laravel 標準のメール認証基盤をアクティブ化。
- **Environment:** Mailpit を活用し、開発環境で実際に認証メールの送受信・リンク確認ができる体制を整備。

### 2. メール認証待ち画面のリファクタリング (VerifyEmail.tsx)
- **デザイン再現:** 旧プロジェクトの `verify-email.css` に基づき、フォントサイズ(24px)、ボタンサイズ(256x70px)、背景色、日本語メッセージを忠実に再現。
- **UX改善:** 開発効率向上のため、Mailpit への直リンクボタン「認証はこちらから」を設置。
- **レイアウト統一:** `GuestLayout` から `AttendanceLayout` へ変更し、未認証状態でも共通ヘッダーが表示されるよう調整。

### 3. 関心の分離に基づくリファクタリング（多重管理の解消）
- **課題:** 複数の認証コントローラーにリダイレクト先ルート `dashboard` がハードコードされており、メンテナンス性が低い状態だった。
- **解決策:**
    - `config/project.php` を新設し、プロジェクト固有の設定項目 `home_route` を定義。
    - 全ての認証関連コントローラー（6箇所）の遷移先を `config('project.home_route')` 参照へ一括置換。
- **効果:** 将来のルート変更が一箇所の修正で完結する、DRY かつ拡張性の高い疎結合な設計を実現。

### 4. 開発用テストデータの日本語化
- **改善:** テストユーザー名が英語で確認しづらかったため、`config/app.php` の `faker_locale` を `ja_JP` に設定し、`migrate:fresh --seed` を実行。
- **結果:** 日本語名のテストデータにより、動作確認時の視認性と親近感が向上。

### 5. テストケースの拡充 (TEST_CASES.md)
- **品質向上:** 動作確認の過程で発見された「未認証状態でのアクセス制限（リダイレクトガード）」を、重要な仕様として `TEST_CASES.md` (ID 16) に正式追記。

---

## 2026-02-12 (続き): Feature テストの完全網羅とセキュリティの堅牢化

### 1. Feature テストの全件移植 (Phase 6)
- **網羅性:** 旧プロジェクトの全 16 ファイルに及ぶテストケースを新プロジェクトへ移植完了。
- **最適化:** 
    - `setUp` / `tearDown` によるテスト時の時刻固定とリセットを徹底し、Flaky Test を排除。
    - Inertia 特有の Props 検証 (`assertInertia`) を導入し、UI データの正確性を担保。
    - 全てのテストメソッド名を日本語化し、旧プロジェクトの意図を完全に継承。

### 2. テスト駆動による品質改善（セキュリティホール解消）
- **認可ガードの強化:** 「他人の勤怠詳細は閲覧できない」テストにおいて、当初 403 を期待したが 200 が返る不備を発見。`AttendanceController` に自分以外のデータを拒否するロジックを追加し、安全性を確保。
- **HTTPステータスの適正化:** 管理者ページへのアクセス制限において、単なるリダイレクト(302)から「権限不足(403)」を正しく返すように `AdminMiddleware` を修正。
- **並び順の厳格検証:** `latest()` や `orderBy('id')` といったソート仕様に対し、Factory を用いた日時操作を行うことで、実行環境に左右されない確実な検証を実現。

### 3. 今後の展望
- 全ての機能要件およびテストケースが緑色（PASS）となり、リファクタリングの正しさが証明された。
- 次回、コードベース全体のフルパス記述（FQCN）を整理し、`use` 文へ統一する最終仕上げを実施予定。

---

## 2026-02-12 (続き): 日本語化の完遂と表示ロジックの最適化

### 1. システム全体の日本語化対応
- **ライブラリ導入:** `laravel-lang/common` を導入し、標準バリデーションメッセージを網羅的に日本語化。
- **FormRequest の整備:** `RegisterRequest` を新設し、`LoginRequest` と共にメッセージ定義を `messages()` メソッドへ集約。
- **一元管理:** 旧プロジェクトの要件（「お名前を入力してください」等）を FormRequest に閉じ込めることで、`validation.php` を汚さないクリーンな設計を達成。

### 2. タイムゾーン起因の表示ズレ（日付・時刻）の根本修正
- **課題:** ISO形式の時刻データを JS 側でパースする際、ブラウザのタイムゾーン変換によって 15時間や 1日のズレが発生していた。
- **解決策 (時刻):** `Attendance` / `Rest` モデルに表示専用のアクセサ（`start_time_hi` 等）を追加し、`$appends` で JSON に含める。これにより JS 側での計算を排除し、サーバー側で整形済みの文字列を直接表示。
- **解決策 (日付):** `work_date` のキャストに `date:Y-m-d` 形式を指定。計算用の精度を保ったまま、シリアライズ時のみ純粋な日付文字列として出力。
- **成果:** バックエンドの計算ロジック（日付依存）を壊すことなく、フロントエンドでの表示不整合を 100% 解消。

### 3. デザインの忠実な再現
- **認証画面:** ログイン・会員登録画面を `AttendanceLayout` ベースにリファクタリングし、白背景化、タイトルの巨大化（36px）、黒ボタン化等、旧プロジェクトのトンマナを精密に再現。
- **リンクの整備:** ログイン・会員登録間の相互リンクを旧プロジェクトと同じ配置・スタイルで追加。

---

## 2026-02-12 (続き): UIアップグレード（Shadcn UI による日付選択のモダン化）

### 1. Shadcn UI コンポーネントの導入
- **追加:** `Calendar` および `Popover` コンポーネントを導入。
- **依存ライブラリ:** `react-day-picker`, `date-fns` を追加し、高度な日付操作基盤を構築。

### 2. 共通コンポーネント DatePicker.tsx の作成
- **設計:** ネイティブの `input type="date"` を置き換えるための、再利用可能な日付選択パーツを作成。
- **仕様:** `date-fns` の `ja` ロケールを適用し、本プロジェクトのトンマナに合わせたボタン形式のトリガーを実装。

### 3. 管理者用日次勤怠一覧への適用
- **改善:** `Admin/Attendance/Index.tsx` において、非表示の `input` タグを用いたハック的な日付選択を排除し、`DatePicker` へ刷新。
- **効果:** ブラウザ間の挙動差異を解消し、直感的で視覚的一貫性のあるモダンなユーザー体験を実現。

### 4. 月次ナビゲーションのアップグレード (MonthPicker)
- **新規:** 月選択に特化した `MonthPicker.tsx` コンポーネントを構築。
- **改善:** `MonthNavigation.tsx` の中央表示部分をインタラクティブなピッカーに置き換え。
- **再利用の成果:** 共通コンポーネントを修正するだけで、一般用および管理者用（スタッフ別）の両月次一覧画面が同時にアップグレードされる、クリーンな設計の利点を実証。

---

## 2026-02-13: テスト網羅の完遂とコードベースの最終洗練

### 1. Feature テストの 100% 網羅 (Phase 6)
- **最終ステータス:** `TEST_CASES.md` に定義された全 16 項目、および `FEATURES.md` の全機能要件をカバーするテストコードの移植・実装が完了。
- **成果:** 全 63 件のテストケース（411アサート）がパスし、リファクタリング後のシステムの健全性を数学的に証明。

### 2. コードクリーンアップ (FQCN の排除)
- **リファクタリング:** プロジェクト全体の PHP ファイルをスキャンし、`\App\Models\...` 等のフルパス記述（FQCN）を徹底的に排除。
- **標準化:** `use` 文への集約とエイリアス（`use ... as Assert` 等）の活用により、コードの可読性とメンテナンス性を飛躍的に向上。
- **規約化:** `99_OLD_IMPLEMENTATION_STANDARDS.md` に本ルールを明文化し、品質基準を永続化。

### 3. 認可ロジックの厳格化
- **改善:** `AdminMiddleware` を修正し、未ログイン（302）と権限不足（403）を正しく出し分けるように変更。セキュリティテスト（異常系）のパスを確認。

### 4. 今後の展望
- 全ての要件を満たした「完成」の状態から、さらなる品質向上（E2Eテスト環境の構築等）へ向けたフェーズへ移行。

---

## 2026-02-13 (続き): E2E テスト基盤の構築と「将軍の視点」による品質担保

### 1. Playwright による E2E テスト環境の構築
- **環境隔離の完遂:**
    - `.env.testing` を新設し、テスト用ポート 8081 および `testing` データベースを専用に割り当て。`APP_URL` をポート番号を含めた形式に修正し、アセット読み込みの整合性を確保。
    - `public/hot` ファイルの自動削除工程を `package.json` に導入し、Vite 開発サーバーと本番ビルドの干渉を物理的に排除。
    - `playwright.config.ts` で `webServer` 機能を活用し、テスト実行時のみサーバーを自動起動・終了させる堅牢な管理を実現。
- **自動化スクリプト:** `npm run test:e2e` コマンド 1 つで「ビルド → DBリセット → サーバー起動 → ブラウザテスト」が完結するパイプラインを `package.json` に構築。

### 2. 最初の E2E テスト合格 (auth.spec.ts)
- **検証内容:** 一般ユーザーおよび管理者のログインフロー、未ログイン時のリダイレクトガード。
- **成果:** 実際のブラウザ（Chromium）上で React コンポーネントが正常にレンダリングされ、バックエンドの認可ロジックと正しく連携していることを証明。
- **デバッグの知見:** 
    - `workers: 1`（直列実行）への制限により、DB 競合を排除。
    - HTML 出力デバッグにより、`public/hot` に起因する React 起動不全を特定。
    - 機能要件（FN019）に基づき、タイトル（h1）ではなくステータス表示（勤務外）を検証対象にするようテストを適正化。

### 3. TypeScript の厳格な管理
- **改善:** `npm run build` をテスト工程に組み込むことで、リファクタリング漏れによるコンパイルエラー（`Approve.tsx` 内の不要プロパティ等）を早期に検知・修正。

### 4. シナリオテストの拡充 (stamp.spec.ts)
- **検証内容:** 出勤 → 休憩（2回） → 戻り → 退勤 という実運用に基づいたフルサイクルの挙動を検証。
- **堅牢性:** `getByRole` セレクタの採用と、各アクション間への 1.1 秒の待機（waitForTimeout）を導入することで、DB上の時刻重複を確実に回避し、アクセシビリティに基づいた確実な要素特定を実現。
- **成果:** 機能要件 (FN021, FN022) に基づくステータス遷移とメッセージ表示が、実際のブラウザ上で完璧に動作することを証明。

### 5. 一覧ナビゲーションの検証 (attendance_list.spec.ts)
- **検証内容:** 「前月」「翌月」ボタンによる遷移、および `MonthPicker` を用いた動的な月選択の動作を検証。
- **技術的知見:** 
    - **遷移待機の重要性:** ログイン後の `page.goto` において、ログイン処理（POST）の完了を待機しないとセッションが確立されずリダイレクトされる SPA 特有の挙動を、`expect(page).toHaveURL()` による待機で解消。
    - **動적テストデータ:** 「1月の呪い（実行月と同じ月を選んでしまう問題）」を回避するため、現在の表示月を判定してターゲットを動的に変更するロジックを導入し、テストの堅牢性を最大化。

---

## 2026-02-13 (続き): 当日勤怠データの修正制限（is_editable）とテスト戦略の高度化

### 1. 「最強の判定ロジック」の実装 (SSOT の確立)
- **課題:** 勤務中の修正を許可するとデータの整合性が崩れるが、閲覧は許可したい。また、深夜残業中の日付跨ぎを考慮する必要があった。
- **解決策:** `Attendance` モデルに `is_editable` アクセサを実装。
    - **アルゴリズム:** 「退勤済み」または「業務日付（日付変更線 05:00）が経過している」場合に `true` を返す。
    - **メリット:** モデルにロジックを集約することで、フロントエンド・バックエンド・テストの全てで共通の「法律」を適用可能。
- **UI連携:** 
    - メッセージを「※当日の修正は退勤後に行えます」というポジティブな表現に変更。
    - `is_editable` に連動して、修正・承認ボタンの非活性化（disabled）および案内メッセージの表示を自動制御。

### 2. 「二段構え」のテスト戦略による品質保証
- **ユニットテスト (AttendanceTest.php):** 
    - **役割:** 境界値（04:59 と 05:00）の精密検査。
    - **成果:** `Carbon::setTestNow()` を駆使し、日またぎ、退勤済み、退勤忘れ等の5パターン全てでロジックの正確性を証明。
- **E2Eテスト (correction_limit.spec.ts):** 
    - **役割:** ユーザー体験（振る舞い）の確認。
    - **成果:** 出勤直後にボタンがロックされ、退勤ボタン押下後に即座に解放される UI 連動の正常性をブラウザ上で証明。

### 3. マルチユーザー承認ワークフローの完遂 (attendance_correction_approval.spec.ts)
- **検証内容:** 一般ユーザーの申請 → 管理者の承認 → 一般ユーザーによる確認 という役割を跨いだ一連のビジネスフローを検証。
- **技術的知見:** 
    - **月初問題の克服:** 実行日が月初（1日）の場合に当月リストに過去データが表示されない問題を、テストの冒頭で「前月」ページへ強制移動する戦略をとることで完全に解決。
    - **データの連続性:** ログイン・ログアウトを繰り返すマルチセッション下において、ユニークな申請理由（タイムスタンプ付与）をキーにデータの整合性をブラウザレベルで保証。
- **成果:** 修正申請から勤怠データへの反映まで、システム全体のハッピーパスが完璧に繋がっていることを証明。

### 3. TypeScript 型安全性の維持
- **改善:** バックエンドの変更に合わせて `models.d.ts` を更新し、`is_editable` プロパティを定義。フロントエンドでの型エラーを完全に解消。

### 4. 課題の検知と戦略的シフト (DatePicker 異常)
- **異常の発見:** 管理者日次一覧の E2E テスト中、カレンダーのキャプション（2024年12月）と日付グリッド（2026年2月）が不一致になる、極めて再現性の低い挙動を検知。
- **技術的分析:** サーバー時刻のズレ（2024年問題）に加え、React の State 更新と Playwright の高速クリックによる競合が疑われる。
- **判断:** E2E テストのみでの解決は困難かつ非効率と判断。問題をより小さな単位に切り分けるため、当初の予定を前倒しし、Vitest + Testing Library によるコンポーネント単体テストフェーズへ移行を決定。
- **目的:** DatePicker 自体の健全性をコードレベルで精密検査し、不確実性を排除した上で E2E を再開する。

### 5. Vitest 単体テスト環境の構築
- **セットアップ:** `vitest`, `@testing-library/react`, `jsdom` を導入。
- **環境整備:** `vitest.config.ts` の作成、および Ziggy や ResizeObserver のモックを含む `setup.ts` を整備。
- **デバッグの深化:** E2E の最終ログより、DatePicker の「キャプション（2024年12月）」と「日付ボタンの aria-label（2026年2月）」が乖離している決定的な証拠を掴んだ。次回、この不整合を単体テストで再現し、根本修正を行う。

---

## 2026-02-14: E2E テスト完全制覇と品質の「現場主義」への昇華

### 1. 管理者日次一覧と DatePicker 検証の完遂 (admin_attendance_index.spec.ts)
- **課題の克服:** `getByRole` がアクセシビリティ名（aria-label）を優先するため、カレンダー内の日付「15」を正確に特定できずタイムアウトする問題を特定。
- **技術的ブレイクスルー（現場主義の確立）:** 
    - **セレクタの転換:** 見えない属性に依存せず、ユーザーが実際に目にしている文字を直接狙う `page.locator('.rdp-day').getByText('15', { exact: true })` を採用し、不確実性を完全に排除。
    - **自律型検証:** 実行環境の時計を信じず、画面の表示年月から「論理的な正解」を動的にパース・計算するロジックを確立。
- **成果:** 全 9 件の E2E シナリオが、環境や実行日時に左右されない「最強の堅牢性」を持って 100% 合格。システムの健全性をブラウザレベルで最終証明した。

### 2. E2E テストの設計思想の昇華と全件制覇
- **課題の根絶:** 同一ユーザー共有による「DB状態の汚染（副作用）」を一括実行時の失敗原因と特定。
- **戦略的解決:** テストファイルごとに独立したユーザー（test1〜test5）を割り当てる「ユーザー分散案」を採用。
- **設計の教訓:** テストの独立性（関心の分離）を物理レベルで保証することの重要性を再認識。
- **最終結果:** 再シードを含む全一括実行において、全 9 シナリオが完全合格。最高品質の統合保証体制が完成。

### 2. 次のフェーズ: Vitest 単体テスト環境の構築
- **整備:** `vitest`, `@testing-library/react`, `jsdom` を導入。Ziggy や ResizeObserver のモックを含む `setup.ts` を完備。
- **目的:** E2E では追いきれない「コンポーネント内部の微細な状態遷移」を単体テストで精密検査する体制へ。

---

## 2026-02-16: セッション復旧と Vitest によるコンポーネント・ロジック検証の完遂

### 1. セッション強制終了からの復旧と現状分析
- **状況把握:** 前回のセッション終了時に未コミット・未記録であった実装内容（Vitest テストおよび修正）を `01_AGENT_RECOVERY_MANUAL.md` に基づき特定。
- **環境再整備:** `package.json` に `test:unit` スクリプトが欠落していたため追加し、Sail 環境でのテスト実行パスを復旧。

### 2. MonthPicker の不具合修正と単体テストの実装
- **不具合修正:** 親コンポーネントからの `month` (Props) の変更が内部状態に反映されない問題を `useEffect` で解決。
- **アクセシビリティ改善:** 年次ナビゲーションボタンに `aria-label="前年/翌年"` を付与し、テストの堅牢性を向上。
- **テスト網羅:** 初期表示フォーマット、年次遷移、月選択時の `onChange` 発火を検証する `MonthPicker.test.tsx` で 100% 合格を確認。

### 3. useCorrectionForm カスタムフックの精密検査
- **テスト実装:** `useCorrectionForm.test.ts` を作成。
- **検証内容:** 
    - 勤怠・休憩データの「フラット化」ロジックの正確性。
    - `isAdmin` フラグによる送信先（一般用 POST / 管理者用 PUT）の動的切り替え。
- **成果:** 修正申請の核心ロジックが UI から独立して正しく動作することを証明。

### 4. 修正申請フォーム（CorrectionForm）の安定化と網羅テストの実装
- **リファクタリング:** `CorrectionForm.tsx` から不要な `React` インポートを削除。
- **UI検証の実装:** `CorrectionForm.test.tsx` を作成し、以下の項目を網羅。
    - **モード切替:** `data` Props の有無による編集/閲覧モードの切り替え検証。
    - **振る舞い検証:** `input[type="time"]` クリック時に `showPicker()` が呼び出されることを、`HTMLInputElement.prototype` のモック化により検証。
    - **動的レンダリング:** `attendance.rests`（マスタ）と `data.rests`（ステート）の両方を同期させたモックデータにより、「休憩n」ラベルと入力欄が動的に増減するロジックを正確に検証。
    - **バリデーション表示:** 指定された HEX 色（`text-[#FF0000]`）によるエラーメッセージ表示の検証。
- **技術的知見:** JSDOM 環境で未実装のブラウザ API（`showPicker`）を検証するためのモック技法、およびマスタデータ依存のレンダリングループをテストで再現するためのデータ設計を確立。

---

### 5. 共通テーブルコンポーネント（AttendanceTable）の単体テスト実装
- **テスト実装:** `AttendanceTable.test.tsx` を作成。
- **検証内容:** 
    - `detailRouteName` プロパティによる動的な URL 生成（一般用/管理者用）の正確性。
    - 勤怠データの有無に応じた詳細リンク/テキストの表示切り替え。
    - テーブルヘッダーおよびデータ行のレンダリング整合性。
- **技術的判断:** `within` を活用したスコープ限定検索と、アクセシビリティ（`columnheader`）に基づく堅牢なセレクタを採用。

### 6. TypeScript 開発環境の最適化（グローバル型定義の有効化）
- **環境整備:** `tsconfig.json` の `include` にテストディレクトリを追加し、`tests/Unit/Frontend/setup.ts` で型定義を一括インポート。
- **成果:** 全テストファイルから冗長な `expect` 等のインポートを排除し、プロジェクト全体で一貫した型解決（および jest-dom マッチャーの認識）を実現。

---

### 【重要】2026-02-16: 記録プロセスにおける規約違反と復旧の記録
- **事象:** AIエージェントが `07_DEV_LOG.md` の更新時、規約（追記型）を無視して `write_file` による全体上書きを試み、過去の記録を消失させかけた。
- **原因:** 技術的実装（テスト完遂）に意識が集中し、ドキュメントの「不可侵性」に対する優先順位が低下したため。また、ツール選択において部分追記（`replace`）ではなく全体置換（`write_file`）という安易な手段を選択したため。
- **是正措置:** ユーザーの厳格な指摘により即座に操作を中断。`tail` コマンドで物理的な末尾を再確認し、既存の記録を一切損なわない形での正しい追記処理を再実行した。
- **教訓:** 開発ログは「常に最新の完成図」ではなく「積み上げられた歴史そのもの」である。記録プロセスは単なるタスクではなく、プロジェクトの継続性を担保する「憲法」であり、いかなる理由があっても上書き・削除は許されない。

---

### 7. ドキュメント構造の再編と整合性の最終同期
- **ドキュメント分割とナンバリング:** `IMPLEMENTATION_STANDARDS.md` を役割ごとに 04 (規約), 05 (設計), 06 (テスト) に分割し、全ファイルに優先順位ベースのナンバリング（01〜07）を適用。アクセシビリティと解像度を向上させた。
- **不整合の解消:** 
    - `01_AGENT_RECOVERY_MANUAL.md` におけるフェーズ定義を Phase 4 から Phase 6（実態）へ更新。
    - `02_RULES_AND_ARCHITECTURE.md` の冒頭参照先を旧版から新分割版へ修正。
    - `03_WORKFLOW.md` における参照リストの漏れ（06）を補完。
- **解像度の復元:** 分割時に簡略化されすぎていた具体的制約（Inertia Link 義務化、Thin Controller の定義、PageProps の継承ルール等）を各ファイルに再統合。
- **環境の永続化:** 99_OLD として旧規約を保持しつつ、新体制での開発準備を完了。

---

### 8. Vitest 実行環境の正常化と型定義スタイルの確定
- **実行時エラーの解消:** `setup.ts` での `vitest/globals` 明示的インポートがモジュール解決エラーを引き起こしていたため、これを削除し実行環境を正常化。
- **型解決の堅牢化:** グローバル設定（`tsconfig.json`）に依存しすぎず、エディタ環境に左右されない安定性を確保するため、各テストファイルで `expect` 等を `vitest` から明示的にインポートする構成に回帰。
- **動作確認:** 全 5 ファイル・17 件の単体テストが Docker Sail 環境で正常にパスすることを確認。

---

## 2026-02-17: CI環境構築前の最終検証と E2E テストの堅牢化

### 1. E2E テストにおけるタイムゾーン不整合の解消
- **課題:** `correction_limit.spec.ts` において、勤務中の修正制限メッセージが表示されない不具合が発生。
- **原因分析:** 
    - `playwright.config.ts` で `timezoneId` が未指定だったため、Node.js 側が UTC で動作し、Laravel 側（JST）の日付判定とズレが生じていた。
    - `Attendance` モデルの `is_editable` アクセサにおいて、`Attribute::get` 内での `$this` 参照がシリアライズ時に不安定になる可能性を特定。
- **修正内容:**
    - `playwright.config.ts` に `timezoneId: 'Asia/Tokyo'` を追加し、実行環境の時刻を同期。
    - `Attendance.php` のアクセサを `Attribute::make` 形式に変更し、`$attributes` 配列から生のDB値を参照する堅牢な実装へリファクタリング。
- **成果:** タイムゾーンに依存しない安定した修正制限判定を実現し、失敗していた E2E テストが正常にパスすることを確認。

### 2. システム全体の健全性最終確認（全テスト合格）
- **テスト網羅:**
    - **Vitest (Unit):** 5 ファイル 17 件（コンポーネント・ロジック） - PASS
    - **Feature (Integration):** 68 件（ビジネスロジック・認可・DB） - PASS
    - **Playwright (E2E):** 9 シナリオ（全ハッピーパス・ワークフロー） - PASS
- **結論:** 全てのテスト層において 100% の合格率を達成し、GitHub Actions による CI 自動化パイプラインの構築に向けた完全な「グリーンの状態」を確立。

---

### 9. GitHub Actions の構築と PR 運用フローの導入
- **CI構築:** `.github/workflows/ci.yml` を作成。PHP 8.4, MySQL 8.0, Node.js 20 環境を自動構成し、Pint, ESLint, PHPUnit, Vitest, Playwright の全 94 テストを自動実行するパイプラインを構築。
- **PR運用フローの採用:** 個人開発の品質と客観性を高めるため、GitHub Flow（ブランチ運用）と Pull Request によるセルフレビュー・CI実行を公式フローとして定義。
- **ドキュメント反映:** `03_WORKFLOW.md` および `01_AGENT_RECOVERY_MANUAL.md` に新ルールを明文化し、AI・人間共に遵守する体制を確立。

---

### 10. Git 履歴を活用した高度なリカバリと CI の最終合格
- **事象:** PR マージ後のローカル統合（rebase）において、手元の古いコード（Lint 未修正）で最新の歴史（Lint 修正済み）を誤って上書きし、デグレードを発生させた。
- **ハンドリング（知恵による解決）:** AI による場当たり的な手動修正をユーザーが制止。「一次情報（成功した歴史）」を重視する卓越した判断により、Git の履歴から直接「正解」を取り戻す戦略を採用。
- **リカバリ実行:**
    - `git checkout [commit_id] -- .` により、ソースコード全域を CI 合格直後の完璧な状態に復元。
    - `git checkout HEAD -- docs-private/` により、最新のドキュメント類のみを現在の `HEAD` から合流。
    - 不備のあった `ci.yml` も、過去の成功地点（`16d5862`）からピンポイントで復元。
- **成果:** 全てのテスト（94件）が GitHub Actions 上で正常にパスし、システム・歴史・ドキュメントの三者が「真の正解」で完全に同期された。

---

## 2026-02-17 (続き): リファクタリング Phase 1 の着手と型定義の基盤強化

### 1. TypeScript 型定義の高度化と厳密化 (Findy スコア向上対策)
- **`utils.d.ts` の新設:** プロジェクト固有のユーティリティ型（`NonNullableFields`）や、Laravel 特有のレスポンス型（`PaginatedResponse`）を定義。
- **`PageProps` の強化:** `types/index.d.ts` において `PageProps` をジェネリクス化し、`auth` や `flash` の型を明示。ESLint の `no-empty-object-type` 警告を考慮し、デフォルト型引数に `Record<string, unknown>` を採用。
- **実装と型定義の分離:** `.d.ts` ファイルにロジック（型ガード）を書かない原則を徹底し、実装は `lib/utils.ts`、型は `types/utils.d.ts` へ適切に配置。

### 2. 型ガードの実装と品質保証
- **Type Guard 導入:** `unknown` を安全に絞り込む `isObject` 関数を実装。
- **回帰検証の徹底:** 
    - **型チェック:** `npx tsc --noEmit` により、既存ページへの影響がないことを確認。
    - **単体テスト:** `utils.test.ts` を新規作成し、型ガードの論理的正確性を Vitest で証明。
- **技術的知見:** 「any を消す」から「unknown を論理的に絞り込む（Type Guard）」スタイルへの昇華を開始。

---

### 3. ドメイン型ガードの堅牢化 (Grade S への昇華)
- **型ガードの強化:** `lib/utils.ts` の `isUser`, `isAttendance` を強化。単なる `in` 演算子によるキーチェックから、`typeof` を用いた「値の型」まで検証する厳密なロジックへリファクタリング。
- **すり抜けリスクの排除:** キーが存在しても型が異なる（例: id が string）不正なデータを正しく `false` と判定するように改善し、ランタイムエラー（toFixed 呼び出し等）を未然に防ぐ堅牢性を確保。
- **テストの拡充:** `utils.test.ts` において「異常系（キーあり・型違い）」のテストケースを追加。合計 10 件のテストで型ガードの論理的完璧性を証明。
- **技術的判断:** 解析エンジンに対する「高度な型絞り込み能力」の証明と、将来的な手戻りを防ぐ「攻めのガード」を両立。

---

### 4. PageProps の厳密化リファクタリング (一般ユーザー側ページ)
- **リファクタリングの実施:** `List.tsx`, `Detail.tsx`, `CorrectionList.tsx`, `Index.tsx` の全 4 ページにおいて、`PageProps` のジェネリクスを適用。
- **型安全性の向上:** ページ固有のデータ型を `PageProps<{ ... }>` として明示的に合成。これにより、共通データ（auth, flash）と固有データの両方に対する完璧な型補完と静的解析を実現。
- **コードの洗練:** 指摘に基づき、中間的な `interface` を排除した `type PageNameProps = PageProps<{ ... }>` 形式のクリーンな記法に統一。
- **品質保証:** `npx tsc --noEmit` により、全ページにおいて型エラーが 0 であることを確認。

---

### 5. プロジェクト全域の PageProps 厳密化の完遂
- **全ページ適用:** 管理者側の主要 6 ページ（Index, Detail, StaffList, StaffAttendanceList, CorrectionList, Approve）に対しても `PageProps<T>` を適用。これにより、プロジェクト内の全ページコンポーネントが高度なジェネリクス型定義へと刷新された。
- **型不整合の解消:** `CorrectionList.tsx` 等で発生していた `interface` と `Record` の制約不整合を、`type` エイリアスへの移行により解決。
- **堅牢な引数設計:** ページコンポーネントの引数（デストラクタリング）において、共通データ `flash` 等を漏れなく受け取れるよう再構成。
- **成果:** フロントエンドの全エントリポイントにおいて、Inertia 共有データとページ固有データの両方が Grade S の型安全性で保護された。

---

### 6. 定数管理の導入とアーキテクチャの適正化 (Phase 1 完遂)
- **定数の一元管理:** `constants/index.ts` を新設し、勤怠・申請ステータスを `as const` で定義。定数から Union Types を自動抽出するロジックを集約し、DRY 原則を徹底。
- **依存関係の逆転 (Architecture):** `User` 型の定義を `index.d.ts` から DB モデルの正解である `models.d.ts` へ移動。依存関係を `Entity -> Application` の順に整理し、不純な循環参照を排除。
- **型定義の高度化:** `FlashMessage` 等の共通型を `PageProps` に正しく適用し、再エクスポート設定によりプロジェクト全域での型解決を安定化。
- **回帰テストの完遂:** 全テスト層（計 104 件：Vitest 27, Feature 68, E2E 9）の 100% 合格を確認。
- **結論:** リファクタリング Phase 1（型定義の基盤強化）を計画通り完了。Findy スコア 60+ を狙える堅牢な型基盤が完成した。

---

## 2026-02-18: リファクタリング Phase 1 の徹底適用と品質の最終化

### 1. 定数管理と型同期の徹底 (DRY & SSOT 遵守)
- **定数適用の完遂:** `Attendance/Index.tsx` 等に残存していたローカルの曜日配列を、共通定数 `DAYS_OF_WEEK` に置き換え。
- **型定義の完全同期:** `CorrectionList.tsx` や管理者用一覧ページでハードコードされていた `'pending' | 'approved'` 形式の共用体型を、`constants` から導出された `CorrectionStatus` 型へ一斉置換。
- **リンクの定数化:** ステータスに基づくクエリパラメータ（`?status=pending` 等）も定数参照に変更し、仕様変更時の修正箇所を一箇所に集約。

### 2. 型ガード（Type Guard）の実装適用
- **ランタイムチェックの導入:** `useCorrectionForm.ts` において、外部から注入される `attendance` オブジェクトの整合性を `isAttendance` 型ガードで検証するロジックを実装。
- **開発効率の向上:** 開発環境（`import.meta.env.DEV`）において、不正なデータ構造が渡された際に即座に警告を出す仕組みを確立し、デバッグの早期化を実現。

### 3. システム全体の健全性再証明
- **型チェック:** `npx tsc --noEmit` によるエラー 0 を継続。
- **全テストパス:** 指摘箇所の修正後、全てのテスト層（計 104 件）が正常にパスすることを確認。
- **技術的教訓:** 「定義の作成」と「実コードへの適用」は表裏一体であり、後者の徹底こそがリファクタリングの真の価値（保守性の向上）を生むことを再認識。

---

## 2026-02-18 (続き): リファクタリング Phase 2 の開始とサーバー駆動型 SSOT 基盤の構築

### 1. DTO および TypeScript 型自動生成パッケージの導入
- **パッケージ選定:** 
    - **`spatie/laravel-data`**: 本番用の DTO 基盤として導入。バリデーションと型定義を一本化する。
    - **`spatie/laravel-typescript-transformer`**: 開発用の型生成ツールとして `--dev` 指定で導入。PHP クラスから TS 型定義を自動出力する。
- **技術的判断:** パッケージの責務を「本番実行用」と「開発ビルド用」に明確に分離することで、プロジェクト構成のクリーンさと本番環境の安定性を両立。
- **初期設定:** 各パッケージの設定ファイル（`data.php`, `typescript-transformer.php`）を公開し、カスタマイズ可能な状態を整備。
- **目的:** 手動管理の `models.d.ts` を脱却し、バックエンドの変更が即座にフロントエンドの型エラーとして検知される「サーバー駆動型 SSOT」の実現へ。

---

### 2. TypeScript 自動生成の成功と出力最適化
- **出力パスの調整:** `config/typescript-transformer.php` を修正し、出力先を `resources/js/types/generated.d.ts` に設定。プロジェクト構成に合わせたディレクトリ配置を確立。
- **自動整形の導入:** `PrettierFormatter` を設定し、生成された型定義が自動的にプロジェクトの規約に沿って整形される仕組みを導入。
- **依存関係の整理:** 未インストールパッケージ（`spatie/php-enum`）への依存によるトランスフォームエラーを解消。
- **最初の SSOT 実装:** `app/Data/UserData.php` を作成し、`php artisan typescript:transform` コマンドにより PHP クラスから TypeScript 型定義が正しく生成されることを確認。
- **成果:** バックエンドの Data オブジェクトを「唯一の正解」としてフロントエンドへ伝搬させるパイプラインが完成。

---

### 3. ドメインモデルの Data Object 化と型チェーンの構築
- **Data Object の定義:** `RestData.php`, `AttendanceData.php` を作成。DB カラム（倉庫）とフロントエンド要求（契約）を分離し、必要なプロパティのみを明示的に定義。
- **ネスト構造の同期:** `AttendanceData` 内に `DataCollection<RestData>` を含めることで、リレーション構造を維持したまま型生成することに成功。
- **自動同期の証明:** `typescript:transform` により、PHP の Nullable 型やコレクション構造が `generated.d.ts` に正確に反映されることを確認。
- **設計の知恵:** 手動定義（d.ts）の「二重管理リスク」を排除し、Data クラスを「唯一の正解（SSOT）」とするアーキテクチャ基盤を確立。

---

### 4. 型チェーンの完成とプロジェクトのクリーンアップ (Phase 2 進展)
- **インフラの繋ぎ変え:** `models.d.ts` の手動定義を廃止。自動生成された `generated.d.ts` をベースに `type Attendance = App.Data.AttendanceData` 等として再エクスポートする「真の SSOT 体制」を確立。
- **不徹底の解消とプロパティ統一:** 
    - 既存コードに残存していたマジックナンバー（曜日配列）やハードコードされた型定義を一掃。
    - プロパティ名を最新の配送規格（`start_time_hi` 等）へ一斉置換し、JS 側での不要な時刻加工ロジックを排除。
- **ミニマリズムの追求 (Cleanup):** 
    - 使用されていない初期ファイル（Dashboard, Welcome, Profile関連、Guest/AuthenticatedLayout）を全て削除。
    - ルーティングおよびコントローラーも本質的な機能のみに絞り込み、未使用インポートを徹底的に排除。
- **品質保証の再証明:** 
    - **Featureテスト:** プロフィール削除に伴う 5 件のテスト削除を経て、全 63 件合格。
    - **E2Eテスト:** 全 9 シナリオの完走を再確認。大規模な構造変更後の健全性を完全に証明。

---

### 5. サーバー駆動型 SSOT の確立と表示ロジックの適正化 (Phase 2 完遂)
- **インフラの全面移行:** 
    - `spatie/laravel-data` および `laravel-typescript-transformer` を導入。
    - `UserData`, `RestData`, `AttendanceData` を定義し、PHP の Data クラスを「唯一の正解」とする型自動生成ラインを構築。
    - `models.d.ts` の手動定義を廃止し、`generated.d.ts` からの再エクスポート構造へ刷新。
- **表示不具合の発見と解消:** 
    - **事象:** 月次一覧で出勤・退勤時刻が非表示になる不具合が発生。
    - **原因:** `CalendarService.php` で Data Object を介さず古い配列形式で詰め替えていたため、プロパティ名の不一致が生じていた。
    - **知恵による解決:** 手動変換を廃止し `AttendanceData::from($attendance)` を徹底適用。インフラによる「厳格な検品」を有効化し、情報の欠落（userリレーション等）を早期に検知・修正。
- **ミニマリズムの追求 (Cleanup):** 
    - 不要な初期ファイル（Dashboard, Welcome, Profile関連）と Breeze 標準レイアウトを一掃。
    - `routes/web.php` および関連コントローラーから本質的でない機能を削除し、プロジェクトの純度を極大化。
- **E2E環境の改善:** `npm run dev` 実行時に `public/hot` が干渉し、テストがフリーズする事象を特定。テスト実行時のホットリロード排除の重要性を再認識。
- **結論:** フロントからバックまで「単一の Data クラス」で繋がる理想的な型チェーンが完成。Findy スコア 60.0+ を狙えるプロフェッショナルな基盤が確立された。

---

### 6. Feature テストのアサーション同期と配送規格の完全合致
- **テストの不整合解消:** `AttendanceListTest` や `StampTest` において、配送規格の変更（`start_time` → `start_time_hi`）に伴うアサーションの失敗を特定。全ての Feature テストを最新のプロパティ名に同期し、全 63 件の合格を確認。
- **インフラの検証力証明:** 手動配列から Data Object への移行により、テストコードが「バックエンドの返却構造の変化」を即座に検知。インフラそのものがテストの一部として機能することを実証。
- **コーディング規約の遵守:** `laravel-data` 導入時に発生した PHP コードスタイル違反（Pint 失敗）を一括修正し、CI パイプラインの健全性を維持。

---

### 7. 型のエントリポイント（窓口）への統一とテストの動的化 (Phase 2 完遂)
- **「型の web.php」体制の確立:** 
    - `resources/js/types/models.d.ts` を型のエントリポイント（窓口）として定義。
    - `App.Data.xxx` という直書きを排除し、全てのコンポーネントが `@/types/models` を介して自動生成された型を利用するようパスを統一。
    - これにより、バックエンドの構造変更による影響を窓口 1 箇所で吸収できる疎結合なアーキテクチャを完成。
- **E2E テストの保守性向上:** 
    - `correction_limit.spec.ts` において、実行環境のタイムゾーンによる「今日の日付」のズレを特定。
    - `date-fns-tz` を導入し、常に `Asia/Tokyo` を基準とした動的な日付検索ロジックへ修正。日付変更に伴うテスト失敗を根本から排除。
- **標準フローの執行:** `npm run test:e2e` コマンドによるビルド・DBリセット・ホットリロード排除の自動化プロセスを徹底し、テストの信頼性を再確立。
- **結論:** サーバー駆動型 SSOT の確立、不要ファイルの整理、そしてアーキテクチャの統一が完了。これにてリファクタリング Phase 2 を 100% 完遂。

---

## 2026-02-19: リファクタリング Phase 2 の真の完遂とクリーンアップ

### 1. 全モデルの SSOT 化完了 (手動定義の 0 化)
- **残存モデルの移行:** `AttendanceCorrection`, `RestCorrection` を PHP の Data Object へ移行。`generated.d.ts` ですべてのモデル型が自動生成される体制を確立。
- **中継地（models.d.ts）の洗練:** 手動定義を完全に削除し、自動生成された型に別名を付けて配布するだけの「純粋な窓口（型の web.php）」へとリファクタリング。
- **アーキテクチャの統一:** 全コンポーネントにおける `App.Data...` の直書きを排除し、`@/types/models` 経由のインポートに統一。疎結合な設計をプロジェクト全域で徹底。

### 2. コード品質の極大化と警告の一掃
- **Lint 警告の撲滅:** 未使用の型インポートやスペル警告（cSpell）をすべて解消。`eslint` および `tsc` でエラー・警告が 0 であることを確認。
- **全テスト層の最終パス:** 大規模なパス変更・定義削除の後、計 99 件のテスト（Vitest, Feature, E2E）が 100% 合格することを実機環境で証明。
- **結論:** 「定義の手間は 0 なのに、使い勝手は最高」という Grade S の型安全基盤が完成。
- **次の一歩:** 堅牢な型基盤の上に、Zod を用いた「ランタイム（実行時）の安全性」を積み上げる Phase 3 へ移行。

---

## 2026-02-19 (続き): リファクタリング Phase 3 (Zod 統合) と E2E 堅牢化の「失われた記録」とデグレード報告

### 1. フロントエンド・バリデーションの強化 (Zod 統合)
- **`correctionSchema.ts` の策定:** 
    - `zod` を導入し、修正申請フォーム用のバリデーションスキーマを定義。
    - 単純な必須チェックに加え、出退勤の逆転防止、休憩時間の重複、休憩の開始・終了漏れといった複雑な相関バリデーションを実装。
    - `z.infer` による `CorrectionFormType` の自動生成により、スキーマを「唯一の正解」とした型定義を確立。
- **カスタムフックへの統合 (`useCorrectionForm.ts`):**
    - `useForm` の型引数を Zod 生成型へ移行。
    - 送信（`handleSubmit`）直前に `safeParse` を実行し、フロントエンド側で即座にエラーを表示する仕組みを構築。
    - `Attendance` オブジェクトへの `isAttendance` 型ガードを適用し、ランタイムでの安全性（Grade S）を担保。

### 2. 時刻比較ユーティリティの拡充
- **`lib/utils.ts` の拡張:** 
    - `isTimeAfter`, `isTimeBeforeOrEqual` を追加。文字列ベース (HH:mm) での正確な時刻比較を実現。
    - **単体テストの完遂:** `utils.test.ts` において、境界値を含む全パターンを網羅。

### 3. E2E テストの「舞台装置」の完成と安定化
- **シーダーの精密制御:** 
    - `AttendancesTableSeeder`, `AttendanceCorrectionSeeder` において、`test4` ユーザーの昨日データを「確実に生成するが、申請は行わない」ように調整。
    - これにより、E2Eテスト (`attendance_correction_approval.spec.ts`) が外部要因（ランダムなシード結果）に左右されない「不変の舞台」を確保。
- **タイムゾーン不整合の根本解決:** 
    - `date-fns-tz` を導入し、テストコード内での日付特定を常に `Asia/Tokyo` 基準で動的にパースする設計へ変更。月初や実行時刻に依存しない堅牢な検索ロジックを確立。

### 4. 【緊急報告】セッション復旧後のデグレード状況
- **事象:** 以上の改善を適用し、プロセス記録直前にセッションが切断された後、再開時の検証で E2E テストの一部が失敗するデグレードを確認。
- **分析:** Zod 統合によるバリデーション強化の影響で、従来のテストシナリオ（特に空文字の扱いや順序チェック）との乖離が生じた可能性がある。
- **今後の対応:** 現在の実装（最新の正解）を優先しつつ、テストコード側の期待値を調整、または Zod スキーマの微修正を行い、全テスト 100% 合格の状態を再奪還する。

### 5. 詳細検証による健全性証明とセッション復旧の完了 (Verification & Completion)
- **事象:** 前項のデグレード懸念に対し、`sail` 環境下での `npm run test:e2e` 実行により詳細な再検証を実施。
- **結論:** 懸念されたデグレードは発生しておらず、すべての E2E テスト（9件）が正常にパスすることを確認。前項の失敗は、エイリアス実行時のパス解決（ホスト環境での php 参照）に起因するものであった。
- **最終結果:** Zod 統合 (Phase 3 初期実装) を含む最新のコードベースにおいて、全 104 件のテスト（Feature 63, Unit 34, E2E 9）が 100% 合格。プロジェクトの健全性を完全に再確認し、セッション復旧を完遂。
- **ドキュメント強化:** `02_RULES_AND_ARCHITECTURE.md` を更新し、「日本語での対話と言語の 厳守」を最優先の憲法として明文化。

---

## 2026-02-20: バリデーションメッセージの SSOT 化と Zod 統合の深化

### 1. バリデーションメッセージの SSOT (Single Source of Truth) 化
- **背景:** フロントエンド (Zod) とバックエンド (FormRequest) でエラー文言が重複し、保守性が低下していた問題を根本解決。
- **実装内容:**
    - `resources/js/constants/validation_messages.json` を新設し、全てのバリデーションメッセージを一元管理。
    - フロントエンドでは JSON を直接 `import` して使用。
    - バックエンドでは `App\Constants\ValidationMessages` クラスをプロキシとして作成し、JSON を読み込んで定数風にアクセスする仕組みを構築。
- **効果:** 文言の変更が JSON 一箇所の修正で全レイヤーに反映される、極めて DRY で堅牢な管理体制を実現。

### 2. フロントエンド検証の動的メッセージ対応
- **ユーティリティ実装:** `lib/utils.ts` に `formatMessage` 関数を追加。Laravel 形式のプレースホルダー (`:min`, `:max` 等) を JS 側で動的に置換可能にした。
- **品質保証:** `utils.test.ts` に単体テストを追加し、複数置換やエッジケースでの動作を確認。

### 3. 認証関連フォームの Zod 化準備
- **スキーマ策定:** `authSchema.ts` を作成し、ログインおよび会員登録用の Zod スキーマを定義。
- **SSOT 適用:** 新設した `validation_messages.json` と `formatMessage` を全面的に適用し、Zod デフォルトの英語メッセージを物理的に排除。

### 4. バックエンド FormRequest のリファクタリング
- **適用範囲:** `RegisterRequest`, `LoginRequest`, `Admin/LoginRequest`, `AttendanceCorrectionRequest` の全 4 ファイルを修正。
- **実装:** ハードコードされた文字列を `ValidationMessages::KEY()` 形式の呼び出しに一括置換。

### 5. クリーンアップと最終検証
- **不要ファイル削除:** プロフィール機能削除に伴い残存していた `ProfileUpdateRequest.php` を削除。
- **全テスト合格:** メッセージ管理構造の大幅な変更後も、全 109 件のテスト (Feature 63, Unit 37, E2E 9) が 100% 合格することを確認。

---

## 2026-02-20 (続き): 会員登録画面 (Register.tsx) への Zod 統合完遂

### 1. フロントエンド・バリデーションの実適用
- **実装対象:** `Pages/Auth/Register.tsx`
- **内容:** 
    - `useForm<RegisterFormType>` の導入による型安全性の確保。
    - 送信（`submit`）直前に Zod スキーマによる検証を実行し、不正なデータ送信をフロントエンドで確実にブロックする仕組みを構築。
    - ユーザー体験向上のため、パスワード確認フィールドのエラー表示領域を新設。

### 2. メッセージ優先順位の同期リファクタリング
- **課題:** Zod が全エラーを一度に返すため、表示メッセージがバックエンド（Laravel）の優先順位（必須チェック優先）と乖離する問題を特定。
- **解決:** `validate` 関数内において、各フィールドの「最初のエラー」のみを抽出してセットするロジックを導入。実機での Laravel の挙動と完璧に同期させた。

### 3. コンポーネント単体テストの確立
- **新規作成:** `Register.test.tsx`
- **検証内容:** 初期表示、空送信時のバリデーション（必須）、文字数制限、パスワード不一致チェックの網羅。
- **技術的課題の克服:** 
    - `<Header>` 内の `usePage` 依存によるテスト失敗をモック拡充で解消。
    - `<title>` と `<h1>` のテキスト重複問題を `getByRole('heading')` によるアクセシビリティ・セレクタで回避。
- **成果:** UI 構造とビジネスロジックの両面で「Grade S」の品質を数学的に証明。

