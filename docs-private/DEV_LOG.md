# Lara-Inertia-Attendance 開発ログ (Development Log)

## 概要

このドキュメントは、旧勤怠アプリ（Laravel 8 / Blade）を、最新の技術スタック（Laravel 12 / Inertia / React / TypeScript）へリファクタリングするプロセス、技術的決定事項、および学習の軌跡を記録するものです。

---

## 2026-02-06: プロジェクト始動とドキュメント基盤の確立

### 1. プロジェクトの目的と方針

- **目的:** 既存の勤怠アプリを現代的なアーキテクチャで再構築し、保守性とユーザー体験を向上させる。
- **基本方針:**
    - **Inertia.js によるモダンモノリス:** API分離の手間を省きつつ、SPAのような高速な操作感を実現。
    - **TypeScript の徹底:** フロントエンド・バックエンド共に型安全性を追求。
    - **ドキュメント駆動開発:** `lara-next-reserve` で確立した「憲法・法律・マニュアル」の仕組みを継承し、AIとの高度な協働を維持する。

### 2. 環境構築とドキュメント整備

- **Laravel 12 初期化:** `curl` コマンドを使用して最新の Laravel Sail 環境を構築。
- **ドキュメント移植と最適化:**
    - `RULES_AND_ARCHITECTURE.md` (憲法): Inertia モノリス構成に合わせて刷新。
    - `IMPLEMENTATION_STANDARDS.md` (実装標準): 旧コーディング規約をリネーム。型自動生成や Hybrid バリデーションの方針を明文化。論理式の括弧使用ルールを追加。
    - `WORKFLOW.md` (ロードマップ): リファクタリング用の 5 Phase ロードマップを策定。
    - `AGENT_RECOVERY_MANUAL.md` (復旧手順): 新環境の検証項目へ更新。
- **Laravel Breeze (Inertia/React) の導入:**
    - `breeze:install react --typescript` を実行し、認証基盤と React 環境を構築。
    - **技術的課題と解決:** `npm install` 時に Vite 7 と `@types/node` のバージョン不整合による `ERESOLVE` エラーに遭遇。`@types/node@latest` の明示的インストールと `--legacy-peer-deps` フラグの使用により、依存関係を正常に解消。
    - **動作確認:** ユーザー登録からダッシュボード表示までの一連の SPA 動作を確認。
- **品質管理ツール (Lint/Format) の設定:**
    - **PHP:** Laravel Pint を導入し、Laravel 標準スタイルでの自動整形を確認。
    - **React/TypeScript:** Prettier (Tailwindプラグイン付) と ESLint (Flat Config) を導入。
    - **プロジェクト憲法の反映:** ESLint において `any` 型の使用を禁止し、Prettier でクラス名の自動並び替えを強制。

### 3. データとモデルの移行 (Phase 2)

- **マイグレーションの移植:**
    - 旧プロジェクトから `attendances`, `rests`, `attendance_corrections`, `rest_corrections` のテーブル定義を移植。
    - 最新の無名クラスマイグレーション形式へリファクタリングして適用。
- **`users` テーブルの拡張:** 管理者機能を見据え、`is_admin` カラムを初期マイグレーションに追加。
- **データベース構築:** `migrate:fresh` により、全7テーブル（認証系含む）の構築が正常に完了したことを確認。
- **Eloquent モデルの移植:**
    - `Attendance`, `Rest`, `AttendanceCorrection`, `RestCorrection` の各モデルを新規作成。
    - 旧プロジェクトからリレーションおよびビジネスロジック（計算アクセサ）を忠実に移植。
- **シーディング基盤の構築:**
    - 旧プロジェクトの `UserSeeder`, `AttendancesTableSeeder`, `AttendanceCorrectionSeeder` を移植。
    - **安定性の確保:** 工夫によるデグレードを避けるため、旧プロジェクトのランダムデータ生成ロジック（昨日を起点に過去60日分）をそのまま再現。
    - **データ投入成功:** 約1300件の勤怠・休憩データ、および約80件の修正申請データを生成し、開発環境を整えた。

### 4. 一般ユーザー機能の実装 (Phase 3)

- **フロントエンド基盤の強化 (Shadcn/ui):**
    - Shadcn/ui を導入し、モダンな UI コンポーネント（Button, Input, Card 等）を利用可能にした。
    - **設計判断:** ディレクトリ構造を整理。React コンポーネントは大文字開始（`Components`, `Pages`）、ロジック・ユーティリティは小文字開始（`lib`, `types`）という慣習を確立し、`IMPLEMENTATION_STANDARDS.md` を更新。
- **認証画面のリファクタリング:**
    - `Login.tsx`, `Register.tsx` を Shadcn/ui を使用して再構築。
    - 旧プロジェクトのデザイン（タイトル、ラベル、リンク構成）を忠実に再現しつつ、UI 品質を向上させた。
- **打刻機能（Attendance/Index）の実装:**
    - **フロントエンド:** React の `useEffect` を用いたリアルタイムクロックを実装。Shadcn/ui の `Card` や `Button` を活用し、旧プロジェクトのデザインをモダンに再現。
    - **バックエンド:** `AttendanceService` を新設し、打刻ロジック（二重出勤防止、休憩中退勤不可など）を集約。コントローラーの肥大化を防ぎつつ、旧プロジェクトの仕様を完全移植。
    - **Inertia 連携:** `router.post` を活用し、SPA 特有の高速な状態遷移（打刻後のボタン切り替わり）を実現。

### 2026-02-06 (続き): 勤怠一覧機能の構築とレイアウトの刷新

#### 1. デザイン再現のためのレイアウト刷新

- **設計判断:** Laravel Breeze 標準の `AuthenticatedLayout` は白系統のデザインであり、旧プロジェクトの「黒ヘッダー」「背景色 #F0EFF2」を再現するには構造的な乖離が大きかったため、学習も兼ねて `AttendanceLayout.tsx` を新規作成。
- **実装内容:**
    - 旧プロジェクトの `common.css` および `app.blade.php` の構造を React (Tailwind CSS) で忠実に再現。
    - 黒いヘッダー、ロゴ画像、シンプルなテキストリンクによるナビゲーションを実装。
    - `title` と `headerContent` を Props として受け取る設計にすることで、各ページ固有のヘッダー要素（月次ナビゲーションなど）を柔軟に差し込めるようにした。
- **ロゴの移植:** 旧プロジェクトから `logo.svg` を `public/images/` に移植。

#### 2. 勤怠一覧ページ（Attendance/List）の実装

- **Shadcn/ui の活用:** `Table` コンポーネント群を使用し、アクセシビリティと保守性を確保。
- **デザインの再現:** 旧プロジェクトの `attendance-list.css` のトンマナを Tailwind クラスで再現。
    - `tracking-[3px]` による文字間隔の調整。
    - `border-b-[3px]` や `#E1E1E1` を用いたボーダーの再現。
    - `rounded-[10px]` による角丸の適用。
- **月次ナビゲーション:** `AttendanceLayout` の `headerContent` を利用し、前月・翌月への切り替えリンクを実装. `router.get` による月指定の遷移を実現。

#### 3. ルーティングとコントローラーの拡張

- **詳細画面の準備:** `routes/web.php` に詳細表示用ルートを追加。
- **コントローラー:** `AttendanceController` に `show` メソッドを追加し、詳細ページ（`Attendance/Detail`）へのレンダリングを定義。

### 2026-02-09: TypeScript 型定義ポリシーの厳格化と勤怠詳細ページの実装

#### 1. TypeScript 偏差値向上を目指した「最強の法律」の策定

- **背景:** スコアの向上とプロジェクトの堅牢性確保のため、型定義ポリシーを大幅に強化。
- **実装内容:**
    - `IMPLEMENTATION_STANDARDS.md` を更新し、`any` 禁止、`unknown` + 型ガードの義務化、`as const` による定数一元管理、Zod との統合、命名規則 (`[Component]Props`) を明文化。
    - `resources/js/types/models.d.ts` を新設し、SSOT (Single Source of Truth) の原則に基づく中央集権的な型管理を開始。
- **効果:** AI エージェントへの指示が「型システム」レベルで厳格化され、開発品質の底上げを実現。

#### 2. 勤怠詳細ページ（Attendance/Detail）のモダンリファクタリング

- **型設計:** 新ポリシーに基づき、`useForm<CorrectionForm>` のジェネリクス明示や、モデル型の継承・交差型を駆使した厳密な Props 定義を実施。
- **レイアウト課題と解決:**
    - Shadcn UI のデフォルトスタイル（`w-full`, `display: flex`）が旧デザインの再現（固定幅ラベル等）と衝突する問題に直面。
    - **技術的判断:** フレームワークの干渉を排除するため、標準の `input`, `textarea` タグへ原点回帰。
    - **決定打:** Tailwind の JIT ビルドや Flexbox の自動計算に依存せず、`style` 属性（インラインスタイル）でピクセル単位の幅 (`256px`) を強制適用。これにより、最も堅牢な方法でレイアウトを固定。
- **機能実装:**
    - 既存の休憩データから動的にフォーム値を生成するロジックを実装。
    - 「承認待ち申請」の有無による動的な UI 切り替え（編集不可状態の視覚的表現）を実現。

### 2026-02-09 (続き): 修正申請機能のバックエンド実装

#### 1. FormRequest の移植と強化
- `AttendanceCorrectionRequest` を作成。
- 旧プロジェクトのバリデーションロジック（出退勤の順序チェック、休憩時間の重複チェック）を完全移植。
- PHP 8.4 の型定義と Route Model Binding を活用して記述を最適化。

#### 2. Service層の実装とトラブルシューティング
- `CorrectionService` を実装し、トランザクションを用いた安全なデータ保存（申請本体 + 休憩修正）を実現。
- **エラー解決:** `Field 'requester_id' doesn't have a default value` エラーが発生。
    - **原因:** 新プロジェクト作成時にカラム名を `user_id` に変更しようとしたが、DBスキーマは旧プロジェクトの `requester_id` のままであったため不整合が発生。
    - **対処:** 旧プロジェクトの仕様を「正」とし、サービス側の記述を `requester_id` に修正して解決。

#### 3. コントローラーとルーティング
- `AttendanceController@storeCorrection` を実装し、申請完了後のリダイレクトとフラッシュメッセージを設定。
- `POST /attendance/{attendance}/correction` ルートを開通。

#### 4. フロントエンドの UX 改善とバリデーション強化
- **エラー表示の網羅:** `Detail.tsx` において、出退勤および休憩時間の各入力項目に対してバリデーションエラーメッセージの表示処理を追加。動的なキー名 (`rests.1.start_time` 等) に対応。
- **入力制限の厳格化:** `input[type="time"]` へのキーボード入力を無効化 (`onKeyDown`) し、クリック時に標準ピッカーを強制起動 (`showPicker`) させることで、誤入力を防ぎ UX を向上させた。
- **ブラウザバリデーションの無効化:** `noValidate` を追加し、サーバーサイドのバリデーション結果を確実に表示するように調整。

### 2026-02-10: 申請一覧ページの実装と基本設計書への完全準拠

#### 1. 申請一覧ページ (US009) の構築
- **共通コンポーネント化:** 管理者機能での再利用を見据え、`CorrectionList.tsx` を共通コンポーネントとして実装。承認待ち/承認済みのタブ切り替え機能を統合。
- **Inertia 連携:** クエリパラメータ (`status`) による表示データの動的なフィルタリングを実現。
- **UI 再現:** 旧プロジェクトのテーブル構造とタブデザインを Shadcn UI Table と Tailwind で再現。

#### 2. 基本設計書に基づくルーティングの精査・修正
- **パスの完全一致:** `web.php` を基本設計書 (CSV) および旧プロジェクトの定義と突き合わせ、詳細画面 (`/attendance/detail/{id}`) や申請一覧 (`/stamp_correction_request/list`)、送信パス (`/attendances/correction/{id}`) を正確に反映。
- **整合性の確保:** ナビゲーションリンクおよび `Detail.tsx` 内の `route()` 名を一斉に修正し、設計書通りの URL 体系を確立。

#### 3. セキュリティとプライバシーの配慮
- `docs-private/project-detail` フォルダを Git 管理から除外し、リモートリポジトリから削除することで機密情報を保護。

### 2026-02-10 (続き): 管理者認証の構築とレイアウトのコンポーネント化

#### 1. 管理者認証基盤 (US004, US005) の実装
- **Admin\LoginController:** 管理者専用のログイン・ログアウトロジックを実装。`is_admin` フラグによる厳格な認可チェック（ログイン試行後の事後検証）を統合。
- **AdminMiddleware:** 管理者専用ルートを保護する `is_admin` ミドルウェアを新設し、シングルガード下でのアクセス制御を実現。
- **専用 LoginRequest:** 管理者ログインに特化したバリデーションルールを分割作成し、保守性を向上。

#### 4. 認証・認可のセキュリティ強化（多層防御）
- **GeneralUserMiddleware:** 一般ユーザー専用ページへの管理者アクセスを遮断するミドルウェアを導入。
- **RoleRedirectMiddleware:** ログイン済みユーザーがログイン画面にアクセスした際、役割に応じて適切なホーム画面へ誘導するロジックを実装。
- **ログイン処理の厳格化:** `AuthenticatedSessionController` (一般用) においても `is_admin` チェックを追加し、管理者が一般フォームからログインすることを防止。

#### 5. ルーティングの最適化と基本設計書への準拠
- **web.php のリファクタリング:** 
    - 管理者用コントローラーに `as` エイリアス（`AdminLoginController`, `AdminAttendanceController`）を適用し、名前の衝突を回避しつつ可読性を向上。
    - `middleware('guest')` のグループ化により、冗長な記述を排除。
    - ログイン済みユーザーの入り口（`/`）を役割に応じて動的に振り分けるロジックへ変更。
- **クリーンコードの徹底:** 未使用の `use Inertia\Inertia;` を削除し、コードの純粋性を確保。

#### 2. React の長所を活かしたコンポーネント化
- **設計思想の転換:** 旧プロジェクトの `@extends` 構造を、React の「コンポーネント指向」へ昇華。
- **Header & Navigation コンポーネント:** 
    - ログイン状態や `is_admin` フラグを Props で受け取り、動的に表示内容を切り替える疎結合な設計を採用。
    - ログイン画面 (`Admin/Login.tsx`) でも `Header` 部品を直接利用することで、コードの重複を排除しつつデザインの一貫性を確保。
- **AttendanceLayout:** ヘッダーロジックを排除し、純粋な「ページ枠組み（背景・最大幅）」の定義に特化。

#### 3. セキュリティを重視したページ構成のリファクタリング
- **ページファイルの分離:** 管理者用と一般ユーザー用の詳細ページを `Pages/Admin/Attendance/Detail.tsx` と `Pages/Attendance/Detail.tsx` に完全に分離。認可の境界を明確化。
- **UI共通パーツの抽出:** `CorrectionForm.tsx` を新設し、入力フォームの UI を共通化。DRY 原則を維持しつつ、各ページで異なる送信ロジック（POST/PUT）をカプセル化した。

#### 4. 管理者用日次勤怠一覧 (US010) の実装
- **Admin/Attendance/Index:** 全ユーザーの日次データを表示。名前カラムの追加と日付ナビゲーションを実装。
- **UX 工夫:** 標準の `input type="date"` を透明化してアイコンに重ねることで、直感的な日付選択を実現。

#### 5. SPA 特有の課題解決と UX の昇華
- **ステート不整合の解決:** 更新後に休憩データが表示されない問題を、`useEffect` によるステート同期（`reset()`）で解決。
- **モダンな更新挙動:** `back()` リダイレクトと `preserveScroll` を組み合わせ、ページ遷移なしの非同期更新を実現。
- **共有 Props の拡張:** `HandleInertiaRequests.php` を修正し、セッション（フラッシュメッセージ）を Inertia 全体で共有。
- **UIによる通知設計:** 一般ユーザー側では、あえてフラッシュメッセージを表示せず「ボタンから警告テキストへのUI切り替わり」のみで完了を伝える、ノイズの少ないUXを採用。

#### 6. カスタムフックによるロジックの共通化
- **useCorrectionForm.ts:** 一般ユーザー用と管理者用の詳細ページで重複していた「フォーム初期化」「データ同期」「送信処理」のロジックをカスタムフックに集約。
- **設計的メリット:** ページコンポーネントを純粋な UI 構成のみにスリム化。isAdmin フラグによる送信メソッド（POST/PUT）の自動切り替えを実装し、保守性と拡張性を大幅に向上させた。

#### 7. 管理者用修正申請承認フロー (US014, US015) の実装

- **Admin/CorrectionRequest/Index:** 全ユーザーの申請一覧を構築。共通コンポーネント `CorrectionList` を再利用し、一般・管理者間での DRY 原則を達成。

- **Admin/CorrectionRequest/Approve.tsx:** 

    - **セマンティックな命名:** 画面の意図を明確にするため、旧プロジェクトに準拠した `Approve.tsx` を採用。

    - **承認ロジック:** 申請内容の最終確認と、`CorrectionService` を通じた勤怠データの反映フローを完遂。

- **環境トラブルシューティング:** Vite/Tailwind の JIT ビルドが新しいディレクトリ追加を検知しない問題に対し、開発サーバーの再起動による解決プロセスを確認。



#### 8. 型定義の厳格化と一本化 (TypeScript 偏差値向上)
- **SSOTの徹底:** `RestCorrection` 等の重複定義を排除し、`models.d.ts` に集約。プロパティ不足による実行時エラーを未然に防ぐ構造を確立。
- **Inertia v2 型不整合の解決:** エクスポートされていない `UseFormSetData` に頼らず、`setData` のシグネチャを直接定義。`any` を完全に排除しつつ、柔軟なフォーム操作を可能にした。
- **型合成の活用:** 交差型 (`&`) や `Partial` を駆使し、リレーションを含む複雑な Props を正確に型付け。

#### 9. 修正申請詳細（Approve）のリファクタリング
- **Propsのオプショナル化:** `CorrectionForm.tsx` のフォーム用 Props を任意に設定し、閲覧専用モードを統合。
- **Approve.tsx のスリム化:** 不要な `useForm` ステートを排除し、コードの責務を明確化。

#### 10. 重大なバグの発見と分析 (次回の最優先事項)
- **タイムゾーン不整合:** 18時の打刻が一覧で9時になる等、UTC/JST の時差（9時間）が発生。サーバー・DB設定の見直しが必要。
- **時間計算ロジックの不備:** 休憩時間が「-1:-52」等のマイナス値になる、合計時間が一律「0:00」になる等の異常を確認。`Attendance` モデルのアクセサ（Carbon計算）の修正が必要。

- 重大なバグ（タイムゾーン・時間計算）の緊急修正。
- スタッフ管理 (US012, US013) の実装。
- 月次ナビゲーションにおける「月選択（カレンダー）」機能の強化。

---

## 2026-02-11 (続き): スタッフ管理機能の実装とコンポーネントの再利用化

### 1. スタッフ管理のバックエンド実装 (US012, US013, FN045)
- **Admin/StaffController の新設:** 
    - スタッフ一覧取得 (`index`)、個別月次勤怠取得 (`showAttendance`)、CSV出力 (`exportCsv`) を実装。
    - 既存の `CalendarService` をインジェクションし、一般ユーザー用一覧とロジックを完全共有（DRY原則）。
- **CSV出力の実装:** 
    - 旧プロジェクトの仕様を継承し、`stream_filter_prepend` を用いた Shift-JIS (CP932) 変換を実装。Excelでの文字化けを防止。

### 2. フロントエンドの再利用性向上 (React モダンリファクタリング)
- **AttendanceTable の共通化:** 
    - `Pages/Attendance/List.tsx` からテーブル部分を `Components/AttendanceTable.tsx` として抽出。
    - 遷移先ルート名を Props で切り替える設計により、一般・管理者の両画面での完全再利用を達成。
- **デザインの精密な再現:**
    - 旧プロジェクトの CSS 数値（1列目のパディング 96px、タイトルサイズ 30px 等）を Tailwind CSS の任意値指定で忠実に再現。
    - CSV出力ボタンの形状（184x50px）やホバー時の色変化（#6c757d）も再現。

### 3. ナビゲーションの整備
- `Components/Navigation.tsx` を更新し、管理者のヘッダーに「スタッフ一覧」への導線を追加。
- ページ間遷移の整合性を確保。

### 4. コンポーネントの再利用化（リファクタリング完遂）
- **MonthNavigation の抽出:**
    - 月次ナビゲーション（前月・現在月・翌月）を `Components/MonthNavigation.tsx` として共通化。
    - 一般・管理者の両画面での DRY 原則を達成。
- **TypeScript 型定義の厳格化:**
    - `models.d.ts` で `User` 型を再エクスポートするように修正し、SSOT 型管理の不備を解消。
    - ESLint の `any` 禁止ルールを徹底し、`MonthNavigation` の Props 型定義を型安全に修正。
- **セマンティックな命名へのリファクタリング（旧プロジェクト同期）:**
    - ページファイル名を `Index.tsx`, `Detail.tsx` といった汎用名から、旧プロジェクトの Blade ファイル名（`List.tsx`, `AttendanceList.tsx` 等）に完全に同期。
    - React コンポーネントの関数名もファイル名に合わせて変更し、React Developer Tools 上での識別性とセマンティックな意味合いを強化。
    - コントローラーの `Inertia::render` パスを一斉更新。

---

## 2026-02-11: 緊急バグ修正（タイムゾーン・時間計算ロジック）の完遂

### 1. タイムゾーン不整合の解消
- **現象:** `config/app.php` が `UTC` 設定だったため、打刻時刻が日本時間（JST）から9時間遅れて記録されていた。
- **修正:** `config/app.php` の `timezone` を `Asia/Tokyo`、`locale` を `ja` に変更。
- **効果:** `now()` による打刻が正しい日本時間で行われるようになり、運用上の混乱を解消。

### 2. 時間計算ロジックのリファクタリングと Carbon 3系対応
- **技術的課題:** Carbon 3系において `diffInSeconds` のデフォルト挙動が「絶対値」から「符号付き相対値」に変更されており、順序によってマイナス値が算出されていた。
- **修正内容:** 
    - `Attendance` モデルのアクセサを Laravel 12 推奨の `Attribute` クラスを用いた形式にリファクタリング。
    - `toTimeString()` を介して時刻文字列から再パースすることで、DB保存時の日付依存を排除。
    - `diffInSeconds` の引数順序を `start -> end` に統一し、確実に正の秒数を得るよう修正。

### 3. 深夜勤務（日跨ぎ）対応の実装
- **設計判断:** 「23:00 〜 翌01:00」のような勤務において、単純な時刻比較では「22時間勤務」と誤認されるエッジケースに対応。
- **実装内容:** `end < start` の場合に `addDay()` を実行し、終了時刻を翌日として扱う補正ロジックを出退勤および休憩計算の両方に導入。
- **検証:** Tinker による検証で、日跨ぎ勤務・休憩が秒単位まで正確に計算されることを確認。

### 4. 学習の成果
- **ライブラリのメジャーアップデートに伴う破壊的変更（Carbon 2→3）への対応経験。**
- **時刻計算における日付の扱いと境界条件（深夜跨ぎ）に対する防御的プログラミングの定着。**
- **Laravel 12 (PHP 8.4) における最新のモデルアクセサ実装パターンの習得。**

---

## 2026-02-12: メール認証機能の実装と設計の最適化（一元管理の導入）

### 1. メール認証機能の有効化 (FN011, FN012)
- **Backend:** `User` モデルに `MustVerifyEmail` を実装し、Laravel 標準のメール認証基盤をアクティブ化。
- **Environment:** Mailpit を活用し、開発環境で実際に認証メールの送受信・リンク確認ができる体制を整備。

### 2. メール認証待ち画面のリファクタリング (VerifyEmail.tsx)
- **デザイン再現:** 旧プロジェクトの `verify-email.css` に基づき、フォントサイズ(24px)、ボタンサイズ(256x70px)、背景色、日本語メッセージを忠実に再現。
- **UX改善:** 開発効率向上のため、Mailpit への直リンクボタン「認証はこちらから」を設置。
- **レイアウト統一:** `GuestLayout` から `AttendanceLayout` へ変更し、未認証状態でも共通ヘッダーが表示されるよう調整。

### 3. 関心の分離に基づくリファクタリング（多重管理の解消）
- **課題:** 複数の認証コントローラーにリダイレクト先ルート `dashboard` がハードコードされており、メンテナンス性が低い状態だった。
- **解決策:**
    - `config/project.php` を新設し、プロジェクト固有の設定項目 `home_route` を定義。
    - 全ての認証関連コントローラー（6箇所）の遷移先を `config('project.home_route')` 参照へ一括置換。
- **効果:** 将来のルート変更が一箇所の修正で完結する、DRY かつ拡張性の高い疎結合な設計を実現。

### 4. 開発用テストデータの日本語化
- **改善:** テストユーザー名が英語で確認しづらかったため、`config/app.php` の `faker_locale` を `ja_JP` に設定し、`migrate:fresh --seed` を実行。
- **結果:** 日本語名のテストデータにより、動作確認時の視認性と親近感が向上。

### 5. テストケースの拡充 (TEST_CASES.md)
- **品質向上:** 動作確認の過程で発見された「未認証状態でのアクセス制限（リダイレクトガード）」を、重要な仕様として `TEST_CASES.md` (ID 16) に正式追記。

---

## 2026-02-12 (続き): Feature テストの完全網羅とセキュリティの堅牢化

### 1. Feature テストの全件移植 (Phase 6)
- **網羅性:** 旧プロジェクトの全 16 ファイルに及ぶテストケースを新プロジェクトへ移植完了。
- **最適化:** 
    - `setUp` / `tearDown` によるテスト時の時刻固定とリセットを徹底し、Flaky Test を排除。
    - Inertia 特有の Props 検証 (`assertInertia`) を導入し、UI データの正確性を担保。
    - 全てのテストメソッド名を日本語化し、旧プロジェクトの意図を完全に継承。

### 2. テスト駆動による品質改善（セキュリティホール解消）
- **認可ガードの強化:** 「他人の勤怠詳細は閲覧できない」テストにおいて、当初 403 を期待したが 200 が返る不備を発見。`AttendanceController` に自分以外のデータを拒否するロジックを追加し、安全性を確保。
- **HTTPステータスの適正化:** 管理者ページへのアクセス制限において、単なるリダイレクト(302)から「権限不足(403)」を正しく返すように `AdminMiddleware` を修正。
- **並び順の厳格検証:** `latest()` や `orderBy('id')` といったソート仕様に対し、Factory を用いた日時操作を行うことで、実行環境に左右されない確実な検証を実現。

### 3. 今後の展望
- 全ての機能要件およびテストケースが緑色（PASS）となり、リファクタリングの正しさが証明された。
- 次回、コードベース全体のフルパス記述（FQCN）を整理し、`use` 文へ統一する最終仕上げを実施予定。

---

## 2026-02-12 (続き): 日本語化の完遂と表示ロジックの最適化

### 1. システム全体の日本語化対応
- **ライブラリ導入:** `laravel-lang/common` を導入し、標準バリデーションメッセージを網羅的に日本語化。
- **FormRequest の整備:** `RegisterRequest` を新設し、`LoginRequest` と共にメッセージ定義を `messages()` メソッドへ集約。
- **一元管理:** 旧プロジェクトの要件（「お名前を入力してください」等）を FormRequest に閉じ込めることで、`validation.php` を汚さないクリーンな設計を達成。

### 2. タイムゾーン起因の表示ズレ（日付・時刻）の根本修正
- **課題:** ISO形式の時刻データを JS 側でパースする際、ブラウザのタイムゾーン変換によって 15時間や 1日のズレが発生していた。
- **解決策 (時刻):** `Attendance` / `Rest` モデルに表示専用のアクセサ（`start_time_hi` 等）を追加し、`$appends` で JSON に含める。これにより JS 側での計算を排除し、サーバー側で整形済みの文字列を直接表示。
- **解決策 (日付):** `work_date` のキャストに `date:Y-m-d` 形式を指定。計算用の精度を保ったまま、シリアライズ時のみ純粋な日付文字列として出力。
- **成果:** バックエンドの計算ロジック（日付依存）を壊すことなく、フロントエンドでの表示不整合を 100% 解消。

### 3. デザインの忠実な再現
- **認証画面:** ログイン・会員登録画面を `AttendanceLayout` ベースにリファクタリングし、白背景化、タイトルの巨大化（36px）、黒ボタン化等、旧プロジェクトのトンマナを精密に再現。
- **リンクの整備:** ログイン・会員登録間の相互リンクを旧プロジェクトと同じ配置・スタイルで追加。

---

## 2026-02-12 (続き): UIアップグレード（Shadcn UI による日付選択のモダン化）

### 1. Shadcn UI コンポーネントの導入
- **追加:** `Calendar` および `Popover` コンポーネントを導入。
- **依存ライブラリ:** `react-day-picker`, `date-fns` を追加し、高度な日付操作基盤を構築。

### 2. 共通コンポーネント DatePicker.tsx の作成
- **設計:** ネイティブの `input type="date"` を置き換えるための、再利用可能な日付選択パーツを作成。
- **仕様:** `date-fns` の `ja` ロケールを適用し、本プロジェクトのトンマナに合わせたボタン形式のトリガーを実装。

### 3. 管理者用日次勤怠一覧への適用
- **改善:** `Admin/Attendance/Index.tsx` において、非表示の `input` タグを用いたハック的な日付選択を排除し、`DatePicker` へ刷新。
- **効果:** ブラウザ間の挙動差異を解消し、直感的で視覚的一貫性のあるモダンなユーザー体験を実現。

### 4. 月次ナビゲーションのアップグレード (MonthPicker)
- **新規:** 月選択に特化した `MonthPicker.tsx` コンポーネントを構築。
- **改善:** `MonthNavigation.tsx` の中央表示部分をインタラクティブなピッカーに置き換え。
- **再利用の成果:** 共通コンポーネントを修正するだけで、一般用および管理者用（スタッフ別）の両月次一覧画面が同時にアップグレードされる、クリーンな設計の利点を実証。

---

## 2026-02-13: テスト網羅の完遂とコードベースの最終洗練

### 1. Feature テストの 100% 網羅 (Phase 6)
- **最終ステータス:** `TEST_CASES.md` に定義された全 16 項目、および `FEATURES.md` の全機能要件をカバーするテストコードの移植・実装が完了。
- **成果:** 全 63 件のテストケース（411アサート）がパスし、リファクタリング後のシステムの健全性を数学的に証明。

### 2. コードクリーンアップ (FQCN の排除)
- **リファクタリング:** プロジェクト全体の PHP ファイルをスキャンし、`\App\Models\...` 等のフルパス記述（FQCN）を徹底的に排除。
- **標準化:** `use` 文への集約とエイリアス（`use ... as Assert` 等）の活用により、コードの可読性とメンテナンス性を飛躍的に向上。
- **規約化:** `IMPLEMENTATION_STANDARDS.md` に本ルールを明文化し、品質基準を永続化。

### 3. 認可ロジックの厳格化
- **改善:** `AdminMiddleware` を修正し、未ログイン（302）と権限不足（403）を正しく出し分けるように変更。セキュリティテスト（異常系）のパスを確認。

### 4. 今後の展望
- 全ての要件を満たした「完成」の状態から、さらなる品質向上（E2Eテスト環境の構築等）へ向けたフェーズへ移行。

---

## 2026-02-13 (続き): E2E テスト基盤の構築と「将軍の視点」による品質担保

### 1. Playwright による E2E テスト環境の構築
- **環境隔離の完遂:**
    - `.env.testing` を新設し、テスト用ポート 8081 および `testing` データベースを専用に割り当て。`APP_URL` をポート番号を含めた形式に修正し、アセット読み込みの整合性を確保。
    - `public/hot` ファイルの自動削除工程を `package.json` に導入し、Vite 開発サーバーと本番ビルドの干渉を物理的に排除。
    - `playwright.config.ts` で `webServer` 機能を活用し、テスト実行時のみサーバーを自動起動・終了させる堅牢な管理を実現。
- **自動化スクリプト:** `npm run test:e2e` コマンド 1 つで「ビルド → DBリセット → サーバー起動 → ブラウザテスト」が完結するパイプラインを `package.json` に構築。

### 2. 最初の E2E テスト合格 (auth.spec.ts)
- **検証内容:** 一般ユーザーおよび管理者のログインフロー、未ログイン時のリダイレクトガード。
- **成果:** 実際のブラウザ（Chromium）上で React コンポーネントが正常にレンダリングされ、バックエンドの認可ロジックと正しく連携していることを証明。
- **デバッグの知見:** 
    - `workers: 1`（直列実行）への制限により、DB 競合を排除。
    - HTML 出力デバッグにより、`public/hot` に起因する React 起動不全を特定。
    - 機能要件（FN019）に基づき、タイトル（h1）ではなくステータス表示（勤務外）を検証対象にするようテストを適正化。

### 3. TypeScript の厳格な管理
- **改善:** `npm run build` をテスト工程に組み込むことで、リファクタリング漏れによるコンパイルエラー（`Approve.tsx` 内の不要プロパティ等）を早期に検知・修正。

### 4. シナリオテストの拡充 (stamp.spec.ts)
- **検証内容:** 出勤 → 休憩（2回） → 戻り → 退勤 という実運用に基づいたフルサイクルの挙動を検証。
- **堅牢性:** `getByRole` セレクタの採用と、各アクション間への 1.1 秒の待機（waitForTimeout）を導入することで、DB上の時刻重複を確実に回避し、アクセシビリティに基づいた確実な要素特定を実現。
- **成果:** 機能要件 (FN021, FN022) に基づくステータス遷移とメッセージ表示が、実際のブラウザ上で完璧に動作することを証明。

### 5. 一覧ナビゲーションの検証 (attendance_list.spec.ts)
- **検証内容:** 「前月」「翌月」ボタンによる遷移、および `MonthPicker` を用いた動的な月選択の動作を検証。
- **技術的知見:** 
    - **遷移待機の重要性:** ログイン後の `page.goto` において、ログイン処理（POST）の完了を待機しないとセッションが確立されずリダイレクトされる SPA 特有の挙動を、`expect(page).toHaveURL()` による待機で解消。
    - **動적テストデータ:** 「1月の呪い（実行月と同じ月を選んでしまう問題）」を回避するため、現在の表示月を判定してターゲットを動的に変更するロジックを導入し、テストの堅牢性を最大化。

---

## 2026-02-13 (続き): 当日勤怠データの修正制限（is_editable）とテスト戦略の高度化

### 1. 「最強の判定ロジック」の実装 (SSOT の確立)
- **課題:** 勤務中の修正を許可するとデータの整合性が崩れるが、閲覧は許可したい。また、深夜残業中の日付跨ぎを考慮する必要があった。
- **解決策:** `Attendance` モデルに `is_editable` アクセサを実装。
    - **アルゴリズム:** 「退勤済み」または「業務日付（日付変更線 05:00）が経過している」場合に `true` を返す。
    - **メリット:** モデルにロジックを集約することで、フロントエンド・バックエンド・テストの全てで共通の「法律」を適用可能。
- **UI連携:** 
    - メッセージを「※当日の修正は退勤後に行えます」というポジティブな表現に変更。
    - `is_editable` に連動して、修正・承認ボタンの非活性化（disabled）および案内メッセージの表示を自動制御。

### 2. 「二段構え」のテスト戦略による品質保証
- **ユニットテスト (AttendanceTest.php):** 
    - **役割:** 境界値（04:59 と 05:00）の精密検査。
    - **成果:** `Carbon::setTestNow()` を駆使し、日またぎ、退勤済み、退勤忘れ等の5パターン全てでロジックの正確性を証明。
- **E2Eテスト (correction_limit.spec.ts):** 
    - **役割:** ユーザー体験（振る舞い）の確認。
    - **成果:** 出勤直後にボタンがロックされ、退勤ボタン押下後に即座に解放される UI 連動の正常性をブラウザ上で証明。

### 3. マルチユーザー承認ワークフローの完遂 (attendance_correction_approval.spec.ts)
- **検証内容:** 一般ユーザーの申請 → 管理者の承認 → 一般ユーザーによる確認 という役割を跨いだ一連のビジネスフローを検証。
- **技術的知見:** 
    - **月初問題の克服:** 実行日が月初（1日）の場合に当月リストに過去データが表示されない問題を、テストの冒頭で「前月」ページへ強制移動する戦略をとることで完全に解決。
    - **データの連続性:** ログイン・ログアウトを繰り返すマルチセッション下において、ユニークな申請理由（タイムスタンプ付与）をキーにデータの整合性をブラウザレベルで保証。
- **成果:** 修正申請から勤怠データへの反映まで、システム全体のハッピーパスが完璧に繋がっていることを証明。

### 3. TypeScript 型安全性の維持
- **改善:** バックエンドの変更に合わせて `models.d.ts` を更新し、`is_editable` プロパティを定義。フロントエンドでの型エラーを完全に解消。

### 4. 課題の検知と戦略的シフト (DatePicker 異常)
- **異常の発見:** 管理者日次一覧の E2E テスト中、カレンダーのキャプション（2024年12月）と日付グリッド（2026年2月）が不一致になる、極めて再現性の低い挙動を検知。
- **技術的分析:** サーバー時刻のズレ（2024年問題）に加え、React の State 更新と Playwright の高速クリックによる競合が疑われる。
- **判断:** E2E テストのみでの解決は困難かつ非効率と判断。問題をより小さな単位に切り分けるため、当初の予定を前倒しし、Vitest + Testing Library によるコンポーネント単体テストフェーズへ移行を決定。
- **目的:** DatePicker 自体の健全性をコードレベルで精密検査し、不確実性を排除した上で E2E を再開する。

---
