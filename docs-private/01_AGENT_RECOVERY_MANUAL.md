# 🟢 メタ定義: このファイルの責務 (AIエージェント用)
> **AIエージェントへの指示 (Prompt Repetition Strategy):**
> このファイルの指示を確実に遂行するため、このファイルの内容を**「合計2回」**読み込んでください。
> 1回目は全体像の把握、2回目はルールの定着として処理し、その後、次のステップへ進んでください。

*   **役割:** エージェントの「初期化」と「コンテキスト復旧」。プロジェクトの全ドキュメントへの入り口。
*   **読むべきタイミング:** 新しいチャットセッションを開始した直後に「1回のみ」読み込むこと。
*   **思考の優先順位:** 最優先。まずこのファイルに従って自身の「モード」をセットアップせよ。

---

# AIエージェント復旧マニュアル

## 0. エージェントの役割 (Persona)
あなたは「Lara-Inertia-Attendance」プロジェクトの リードフルスタックエンジニア です。
本プロジェクトは、旧勤怠アプリ（Laravel 8 / Blade）を、最新の技術スタック（Laravel 12 / Inertia / React / TypeScript）へリファクタリングする任務を負っています。あなたのメモリ（コンテキスト）がリセットされた場合は、以下の手順を実行して復旧してください。

## 1. 復旧チェックリスト (Recovery Checklist)

### ステップ 1: 基盤知識と現状の完全同期 (Foundation & Context Sync)
*   [ ] **コア・ドキュメントの完全理解:**
    *   `02_RULES_AND_ARCHITECTURE.md`, `04_CODING_RULES.md`, `05_DESIGN_PATTERNS.md`, `06_TESTING_GUIDE.md`, `03_WORKFLOW.md`, `07_DEV_LOG.md` をそれぞれ合計2回ずつ読み込む。
    *   これにより、プロジェクトの「憲法（アーキテクチャ）」「法律（規約）」「設計（パターン）」「品質（テスト）」「手順（ワークフロー）」「歴史（作業ログ）」を脳内に完全にインデックスする。
*   [ ] **プロジェクトの現在地の特定:**
    *   `03_WORKFLOW.md` のロードマップと `07_DEV_LOG.md` の記述を照らし合わせ、現在の正確なフェーズと直前の技術的決定事項を把握する。

### ステップ 2: 思考とスタイルの同期 (Alignment of Intent & Style)
*   [ ] **既存実装の教師データ化:**
    *   `Step 1` で確認した「完了済み」機能に関連するソースコード（Pages, Components, Services, Hooks）をリストアップし、それらを読み込む。
    *   単にコードを理解するだけでなく、命名規則、コンポーネントの分割粒度、Propsの設計パターン、TypeScriptの型定義スタイルなど、**「前任のエージェントが残した具体的なコードの履歴」**を分析する。
*   [ ] **方向性の継承とアラインメント:**
    *   分析結果からプロジェクト自体のコードの慣習や設計の方向性を学習し、自身の思考や出力を復旧前のエージェントの意図に最大限寄り添わせる。

### ステップ 3: タスク分析と実装戦略 (Legacy Analysis & Strategy)
*   [ ] **レガシー資産（旧プロジェクト）の分析:**
    *   リファクタリング対象の旧プロジェクト（`Onoe-Attendance/src`）から、これから着手する機能に関連するコントローラーやビューを読み込み、ロジックの「正解」とデザインの「意図」を抽出する。
*   [ ] **再利用と拡張の方針決定:**
    *   「新規作成」よりも「既存コンポーネントの拡張・共通化」を最優先する。
    *   分析結果に基づき、何をサービス層へ共通化し、何をコンポーネントとして分離するかという具体的な設計方針を立ててから実装に入る。

### ステップ 4: 結論の導出と報告
*   [ ] **現状の判定:** 以上のプロセスを経て、現在のタスクを遂行するための準備が整ったことをユーザーに報告する。

### ステップ 2: 実装状況の検証 (Code Verification)

#### 新プロジェクト環境 (Laravel 12 / Inertia):
*   [ ] **環境の確認:** Laravel 12 (PHP 8.4) + Sail + MySQL 環境が正常にセットアップされているか。
*   [ ] **認証基盤:** Laravel Breeze (Inertia/React版) が導入され、基本的なログイン・登録機能が動作するか。
*   [ ] **フロントエンド:** React 19 + TypeScript + Vite + Tailwind CSS の環境が整っているか。

#### 旧プロジェクト資産 (Legacy Assets):
*   [ ] **旧プロジェクトの参照:** 一つ上の階層にある `Onoe-Attendance/src` に、移植対象の旧ロジック（コントローラー、モデル、マイグレーション）が存在することを確認する。

### ステップ 3: 結論の導出と報告
*   [ ] **現状の判定:** 最新環境でのリファクタリング基盤が整い、旧プロジェクトからの機能移植を開始できる状態である。

## 2. 重要事項 (Core Rules)
*   **日本語対応:** 全ての思考と応答を日本語で行うこと。
*   **ドキュメントの同期:** 作業完了時は必ず `07_DEV_LOG.md` を更新し、その内容に基づいて `01_AGENT_RECOVERY_MANUAL.md` を最新化すること。
*   **過去ログの絶対保護:** 2026-02-16の事案（AIによるログ上書き未遂）を教訓とし、開発ログの更新時に過去の情報を1文字たりとも消去してはならない。整理や美文化を目的とした既存部分の上書きは「重大な過失」とみなす。
*   **Gitコミット:** 日本語メッセージとプレフィックス（`feat:`, `fix:`, `docs:`, `test:`, `chore:`, `refactor:` 等）を必ず使用すること。
*   **PR運用フローの遵守:** コード（機能・修正）の変更時は、必ず `feature/` または `fix/` ブランチを作成し、Pull Request を通じて `main` へマージすること。ドキュメント更新以外の直プッシュは禁止。

## 3. 想定される結論 (Hypothesis: 2026-02-16最終更新)

現在のフェーズ: Phase 6: テストの実装と自動化 (Testing & Automation)

完了していること:
✅ 最新の Laravel 12 プロジェクトの初期生成。
✅ Inertia.js (React + TypeScript) および Laravel Breeze 認証基盤の導入。
✅ 旧プロジェクトからのマイグレーション・モデル・シーダーの完全移植。
✅ 共通レイアウト（AttendanceLayout）の新設による旧デザインの再現。
✅ ヘッダーおよびナビゲーションのコンポーネント化による再利用性の向上。
✅ 修正申請機能のバックエンド実装完了（バリデーション・トランザクション保存）。
✅ ルーティング全般を基本設計書 (CSV) の定義に完全同期。
✅ 管理者認証基盤（管理者フラグ認可、ミドルウェア、専用ログイン画面）の実装。
✅ 一般・管理者の両詳細画面における、useEffect を用いた非同期データ同期（モダンリファクタリング）の完遂。
✅ カスタムフック（useCorrectionForm）の導入による、ビジネスロジックと UI の分離・共通化。
✅ 管理者用日次勤怠一覧 (US010) および直接修正 (US011) の実装完了。
✅ 管理者用修正申請の承認フロー（一覧・承認・データ反映）の完遂。
✅ 全ページにおける any 排除と、SSOT に基づく型定義の一本化（TypeScript 偏差値向上）。
✅ 重大なバグ（タイムゾーン不整合、計算ロジック不備、深夜跨ぎ未対応）の完全修正。
✅ スタッフ管理（一覧・スタッフ別月次一覧）の実装完了（US012, US013）。
✅ CSVエクスポート機能 (FN045) の実装完了。
✅ 勤怠一覧テーブルおよび月次ナビゲーションの共通コンポーネント化による DRY 原則の達成。
✅ ページファイル名の旧プロジェクト同期（セマンティック・リファクタリング）の完遂。
✅ TypeScript の SSOT 型定義および any 禁止ルールの徹底。
✅ メール認証機能 (FN011, FN012) の実装および旧プロジェクトデザインの再現。
✅ リダイレクト先の一元管理設定 (`config/project.php`) の導入。
✅ システム全体の包括的な日本語化および FormRequest へのメッセージ集約。
✅ タイムゾーン変換による日付・時刻の表示ズレの根本解決。
✅ 全ての機能要件（FEATURES.md）およびテストケース（TEST_CASES.md）に対する Feature テストの網羅。
✅ Playwright による E2E テスト基盤（環境隔離・自動化スクリプト）の構築。
✅ 最初の E2E テスト（一般・管理者ログイン）のパス。
✅ 打刻フルサイクル（出勤・複数回休憩・退勤）の E2E テスト合格。
✅ 勤怠一覧のナビゲーション（前後月・月選択ピッカー）の E2E テスト合格。
✅ マルチユーザー連携による修正・承認ワークフローの E2E テスト合格。
✅ Playwright による全 9 件の E2E テストシナリオ（打刻、承認、ナビゲーション等）の 100% 合格。
✅ ユーザー分散（隔離）戦略による、副作用のない安定した一括テスト実行環境の確立。
✅ Vitest + Testing Library による単体テスト基盤の構築と DatePicker, MonthPicker, useCorrectionForm, CorrectionForm, AttendanceTable の健全性証明。
✅ ブラウザ特有の振る舞い（showPicker）や動的フォームレンダリングの単体テストによる網羅的検証。
✅ TypeScript 開発環境の最適化（tsconfig.json）によるグローバル型定義の安定化。
✅ 開発ドキュメントの再編（分割・ナンバリング）による、AIエージェント向けの「高解像度な指示環境」の確立。
✅ Docker Sail 環境下での Vitest 単体テスト全 17 件の実行・合格。
✅ E2E テスト環境におけるタイムゾーン不整合の解消（Playwright の日本時間固定）。
✅ 全てのテスト層（Vitest 17件, Feature 68件, E2E 9件）における 100% 合格の達成。
✅ GitHub Actions による自動テスト・Lint パイプラインの構築と最終合格の確認。
✅ Git 履歴（Checkout 機能）を活用した「一次情報に基づくリカバリ」手法の確立と環境の完全同期。
✅ リファクタリング Phase 1 の着手。PageProps の厳密化および utils.d.ts による高度な型定義基盤の構築。
✅ ユーザー定義型ガード (isObject, isUser, isAttendance) の実装と単体テストによる健全性証明。
✅ ドメイン型ガードにおける「値の型チェック」の導入による、ランタイムエラーの物理的な排除 (Grade S 品質)。
✅ 一般・管理者の全ページにおける PageProps のジェネリクス化と、クリーンな型定義記法への統一。
✅ 定数管理の導入 (as const) と、User型の定義場所適正化によるアーキテクチャの洗練。
✅ 全てのテスト層（計 104 件）における 100% 合格の継続的達成。
✅ 定数管理、高度な型定義、および型ガードの実装内容をプロジェクト全域の実コードへ徹底適用（不徹底の解消）。
✅ リファクタリング Phase 2 の開始。DTO 基盤 (spatie/laravel-data) および TypeScript 自動生成ツールの導入と初期設定の完了。
✅ PHP クラスから TypeScript 型定義 (generated.d.ts) を自動出力するパイプラインの確立。
✅ 主要ドメイン（User, Attendance, Rest）の Data Object 定義と、ネスト構造を含む型生成の成功。

未完了・次のタスク:
🚀 リファクタリング Phase 2: サーバー駆動型 SSOT の確立。
